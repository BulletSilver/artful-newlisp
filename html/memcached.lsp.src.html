<!DOCTYPE HTML PUBLIC "4.01 Transitional"><html><title>memcached</title><body><pre>
<font color='#555555'>;; <font color='#308080'>@module</font> memcached</font>
<font color='#555555'>;; <font color='#308080'>@author</font> Jeff Ober &lt;jeffober@gmail.com&gt;</font>
<font color='#555555'>;; <font color='#308080'>@version</font> 0.3</font>
<font color='#555555'>;; <font color='#308080'>@location</font> http://static.artfulcode.net/newlisp/memcached.lsp</font>
<font color='#555555'>;; <font color='#308080'>@package</font> http://static.artfulcode.net/newlisp/memcached.qwerty</font>
<font color='#555555'>;; <font color='#308080'>@description</font> Interface to libmemcached (http://tangent.org/552/libmemcached.html) (updated for newlisp 10)</font>
<font color='#555555'>;; &lt;p&gt;This module is a work-in-progress. Currently implemented functions work (or at least they</font>
<font color='#555555'>;; appear to). The full range of functionality is not nearly implemented, but it works well enough</font>
<font color='#555555'>;; to allocate, connect, get/set keys, and disconnect/deallocate.&lt;/p&gt;</font>
<font color='#555555'>;; &lt;h4&gt;External libraries&lt;/h4&gt;</font>
<font color='#555555'>;; &amp;bull;</font>
<font color='#555555'>;; <font color='#308080'>@link</font> http://tangent.org/552/libmemcached.html libmemcached&lt;br&gt;</font>
<font color='#555555'>;; &amp;bull;</font>
<font color='#555555'>;; <font color='#308080'>@link</font> http://www.danga.com/memcached/download.bml memcached&lt;br&gt;</font>
<font color='#555555'>;; &amp;bull;</font>
<font color='#555555'>;; <font color='#308080'>@link</font> http://monkey.org/~provos/libevent/ libevent&amp;nbsp;(required&amp;nbsp;by&amp;nbsp;memcached)</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;h4&gt;Version history&lt;/h4&gt;</font>
<font color='#555555'>;; &lt;b&gt;0.3&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; updated for newlisp 10</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;0.2&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; cleaned up some functions</font>
<font color='#555555'>;; &amp;bull; added 'get-keys'</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;0.1&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; development release</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (memcached:init)</font>
<font color='#555555'>;; (memcached:add-server "localhost" 8080)</font>
<font color='#555555'>;; (memcached:set-key "foo" "bar" 30)</font>
<font color='#555555'>;; (memcached:get-key "foo") ; within 30 seconds</font>
<font color='#555555'>;; => "bar"</font>
<font color='#555555'>;; (sleep 30000) ; wait 30 seconds</font>
<font color='#555555'>;; (memcached:get-key "foo") ; after 30+ seconds</font>
<font color='#555555'>;; => nil</font>
<font color='#555555'>;; (memcached:disconnect)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> 'memcached<font color='#AA0000'>)</font>

<font color='#555555'>;;; note: technique robbed from mysql5.lsp</font>

<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> files '<font color='#AA0000'>(</font><font color='#008800'>"/usr/local/lib/libmemcached.so"</font> <font color='#008800'>"/usr/local/lib/libmemcached.dylib"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> libmemcached
  <font color='#AA0000'>(</font>files <font color='#AA0000'>(</font><font color='#0000AA'>or</font> <font color='#AA0000'>(</font><font color='#0000AA'>find</font> <font color='#0000AA'>true</font> <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>file?</font> files<font color='#AA0000'>)</font><font color='#AA0000'>)</font> 
				     <font color='#AA0000'>(</font><font color='#0000AA'>begin</font> <font color='#AA0000'>(</font><font color='#0000AA'>println</font> <font color='#008800'>"cannot find libmemcached library"</font><font color='#AA0000'>)</font>
	                  <font color='#AA0000'>(</font><font color='#0000AA'>exit</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmemcached <font color='#008800'>"memcached_create"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmemcached <font color='#008800'>"memcached_free"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmemcached <font color='#008800'>"memcached_server_add"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmemcached <font color='#008800'>"memcached_strerror"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmemcached <font color='#008800'>"memcached_quit"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmemcached <font color='#008800'>"memcached_set"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmemcached <font color='#008800'>"memcached_get"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmemcached <font color='#008800'>"memcached_mget"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmemcached <font color='#008800'>"memcached_fetch"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmemcached <font color='#008800'>"memcached_result_create"</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> MEMCACHED <font color='#0000AA'>nil</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> MEMCACHED_RETURN <font color='#0000AA'>nil</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> ERROR <font color='#0000AA'>nil</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (memcached:init)</font>
<font color='#555555'>;; &lt;p&gt;Initializes the 'memcached' module.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>init<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> MEMCACHED <font color='#AA0000'>(</font>memcached_free MEMCACHED<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> MEMCACHED <font color='#AA0000'>(</font>memcached_create <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>zero?</font> MEMCACHED<font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> MEMCACHED <font color='#0000AA'>nil</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>not</font> <font color='#AA0000'>(</font><font color='#0000AA'>nil?</font> MEMCACHED<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (memcached:disconnect)</font>
<font color='#555555'>;; &lt;p&gt;Disconnects from all servers and deallocates libmemcached structures.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>disconnect<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>when</font> MEMCACHED
    <font color='#AA0000'>(</font>memcached_quit MEMCACHED<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font>memcached_free MEMCACHED<font color='#AA0000'>)</font>
    <font color='#0000AA'>true</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (memcached:add-server &lt;str-host&gt; &lt;int-port&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-host&gt; the hostname; required</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;int-port&gt; the host port; required</font>
<font color='#555555'>;; &lt;p&gt;Adds a server to be used as a source of cached data. Returns true or nil,</font>
<font color='#555555'>;; depending on whether the server was successfully added or not.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (memcached:add-server "localhost" 8000)</font>
<font color='#555555'>;; => true</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>add-server host port<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>when</font> MEMCACHED
    <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> MEMCACHED_RETURN <font color='#AA0000'>(</font>memcached_server_add MEMCACHED host port<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>=</font> <font color='#008800'>"SUCCESS"</font> <font color='#AA0000'>(</font>result<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (memcached:result)</font>
<font color='#555555'>;; &lt;p&gt;Returns the result or error from the last operation.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>result<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>and</font> MEMCACHED MEMCACHED_RETURN<font color='#AA0000'>)</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>get-string</font> <font color='#AA0000'>(</font>memcached_strerror MEMCACHED MEMCACHED_RETURN<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (memcached:set-key &lt;str-key&gt; &lt;expr-value&gt; [&lt;int-expiration&gt;])</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-key&gt; unique key to store &lt;expr-value&gt; under; required</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-expr&gt; value to store under &lt;str-key&gt;; required</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;int-expiration&gt; seconds until &lt;str-key&gt; will expire; optional</font>
<font color='#555555'>;; &lt;p&gt;Sets &lt;str-key&gt; to &lt;str-expr&gt; on the memcached server. &lt;str-expr&gt; will be serialized</font>
<font color='#555555'>;; using 'string'. Keys that already exist are overwritten. Returns true for success,</font>
<font color='#555555'>;; nil for failure.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (memcached:set-key "foo" "bar" 30) ; sets "foo" to "bar" for 30 seconds</font>
<font color='#555555'>;; => true</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>_set-key key value expiration<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>when</font> MEMCACHED
    <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> key <font color='#AA0000'>(</font><font color='#0000AA'>string</font> key<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> value <font color='#AA0000'>(</font><font color='#0000AA'>string</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> MEMCACHED_RETURN <font color='#AA0000'>(</font>memcached_set MEMCACHED key <font color='#AA0000'>(</font><font color='#0000AA'>length</font> key<font color='#AA0000'>)</font>
                                                    value <font color='#AA0000'>(</font><font color='#0000AA'>length</font> value<font color='#AA0000'>)</font>
                                                    expiration <font color='#0000AA'>nil</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>=</font> <font color='#008800'>"SUCCESS"</font> <font color='#AA0000'>(</font>result<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>set-key key value expiration<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font>_set-key key value expiration<font color='#AA0000'>)</font>
      value<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (memcached:get-key &lt;str-key&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-key&gt; the key to retrieve; required</font>
<font color='#555555'>;; &lt;p&gt;Retrieves the value associated with &lt;str-key&gt; from the memcached server. If the</font>
<font color='#555555'>;; key does not exist or has expired, evaluates to nil. Otherwise, the string value</font>
<font color='#555555'>;; is returned.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (memcached:set-key "foo" '("bar" "baz" "bat") (* 60 60))</font>
<font color='#555555'>;; => true</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; (memcached:get-key "foo")</font>
<font color='#555555'>;; => "(&#092;&#034;bar&#092;&#034; &#092;&#034;baz&#092;&#034; &#092;&#034;bat&#092;&#034;)"</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; (let ((res (memcached:get-key "foo")))</font>
<font color='#555555'>;;   (if res (eval-string (string "'" res)))) ; evaluate quoted</font>
<font color='#555555'>;; => ("bar" "baz" "bat")</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>get-key key , res <font color='#AA0000'>(</font>value-length <font color='#665500'>0</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>flags <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>when</font> MEMCACHED
    <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> res <font color='#AA0000'>(</font>memcached_get MEMCACHED
                             key <font color='#AA0000'>(</font><font color='#0000AA'>length</font> key<font color='#AA0000'>)</font>
                             <font color='#AA0000'>(</font><font color='#0000AA'>address</font> value-length<font color='#AA0000'>)</font>
                             <font color='#AA0000'>(</font><font color='#0000AA'>address</font> flags<font color='#AA0000'>)</font>
                             <font color='#AA0000'>(</font><font color='#0000AA'>address</font> MEMCACHED_RETURN<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>unless</font> <font color='#AA0000'>(</font><font color='#0000AA'>zero?</font> res<font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>get-string</font> res<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>_fetch key , klen vlen flags res<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> klen <font color='#AA0000'>(</font><font color='#0000AA'>address</font> <font color='#AA0000'>(</font><font color='#0000AA'>length</font> key<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
        vlen <font color='#AA0000'>(</font><font color='#0000AA'>address</font> <font color='#665500'>0</font><font color='#AA0000'>)</font>
        flags <font color='#AA0000'>(</font><font color='#0000AA'>address</font> <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> res <font color='#AA0000'>(</font>memcached_fetch MEMCACHED key klen vlen flags <font color='#AA0000'>(</font><font color='#0000AA'>address</font> MEMCACHED_RETURN<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>=</font> <font color='#665500'>0</font> res<font color='#AA0000'>)</font> <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font><font color='#0000AA'>get-string</font> res<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (memcached:get-keys &lt;list-keys&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;list-keys&gt; a list of strings</font>
<font color='#555555'>;; &lt;p&gt;Fetches an association list of '(key value) pairs from the</font>
<font color='#555555'>;; server.  Invalid or expired values return nil.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (memcached:set-key "foo" "bar" 300)</font>
<font color='#555555'>;; => "bar"</font>
<font color='#555555'>;; (memcached:set-key "baz" "bat" 300)</font>
<font color='#555555'>;; => "bat"</font>
<font color='#555555'>;; (memcached:set-key "asdf" "qwerty" 300)</font>
<font color='#555555'>;; => "qwerty"</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; (memcached:get-keys '("foo" "baz" "asdf")</font>
<font color='#555555'>;; => (("foo" "bar") ("baz" "bat") ("asdf" "qwerty"))</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; (memcached:get-keys '("foo" "invalid" "expired"))</font>
<font color='#555555'>;; => (("foo" "bar") ("invalid" nil) ("expired" nil))</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>get-keys list-keys , res num-keys s-keys keys len-s-keys lengths<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> MEMCACHED_RETURN <font color='#0000AA'>nil</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>when</font> MEMCACHED
    <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> num-keys <font color='#AA0000'>(</font><font color='#0000AA'>length</font> list-keys<font color='#AA0000'>)</font>
          s-keys <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>string</font> list-keys<font color='#AA0000'>)</font>
          keys <font color='#AA0000'>(</font><font color='#0000AA'>pack</font> <font color='#AA0000'>(</font><font color='#0000AA'>dup</font> <font color='#008800'>"lu"</font> num-keys<font color='#AA0000'>)</font> s-keys<font color='#AA0000'>)</font>
          len-s-keys <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>length</font> s-keys<font color='#AA0000'>)</font>
          lengths <font color='#AA0000'>(</font><font color='#0000AA'>pack</font> <font color='#AA0000'>(</font><font color='#0000AA'>dup</font> <font color='#008800'>"lu"</font> num-keys<font color='#AA0000'>)</font> len-s-keys<font color='#AA0000'>)</font>
          MEMCACHED_RETURN <font color='#AA0000'>(</font>memcached_mget MEMCACHED keys lengths num-keys<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>when</font> <font color='#AA0000'>(</font><font color='#0000AA'>=</font> <font color='#AA0000'>(</font>result<font color='#AA0000'>)</font> <font color='#008800'>"SUCCESS"</font><font color='#AA0000'>)</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> res '<font color='#AA0000'>(</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>dolist</font> <font color='#AA0000'>(</font>key list-keys<font color='#AA0000'>)</font>
        <font color='#AA0000'>(</font><font color='#0000AA'>push</font> <font color='#AA0000'>(</font><font color='#0000AA'>list</font> key <font color='#AA0000'>(</font>_fetch key<font color='#AA0000'>)</font><font color='#AA0000'>)</font> res <font color='#665500'>-1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  res<font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> 'MAIN<font color='#AA0000'>)</font>



</pre><center><font face='Arial' size='-3' color='#666666'>syntax highlighting with <a href="http://newlisp.org">newLISP</a>&nbsp;and <a href="http://newlisp.org/newLISPdoc.html">newLISPdoc</a></font></center></body></html>
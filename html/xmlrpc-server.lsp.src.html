<!DOCTYPE HTML PUBLIC "4.01 Transitional"><html><title>Xmlrpc-server</title><body><pre>
<font color='#555555'>;; <font color='#308080'>@module</font> Xmlrpc-server</font>
<font color='#555555'>;; <font color='#308080'>@author</font> Jeff Ober &lt;jeffober@gmail.com&gt;</font>
<font color='#555555'>;; <font color='#308080'>@version</font> 1.1</font>
<font color='#555555'>;; <font color='#308080'>@location</font> http://static.artfulcode.net/newlisp/xmlrpc-server.lsp</font>
<font color='#555555'>;; <font color='#308080'>@package</font> http://static.artfulcode.net/newlisp/xmlrpc-server.qwerty</font>
<font color='#555555'>;; <font color='#308080'>@description</font> A simple XML-RPC server (updated for newlisp 10).</font>
<font color='#555555'>;; Xmlrpc-server implements a basic XML-RPC server. It requires the element,</font>
<font color='#555555'>;; http, sockets, and util modules, and newlisp 10.</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; Xmlrpc-server is able to convert data between xmlrpc and newLISP. Any uncaught</font>
<font color='#555555'>;; errors that occur during the loading of a response are handled by returning a fault</font>
<font color='#555555'>;; response. Fault codes are gleaned from</font>
<font color='#555555'>;; <font color='#308080'>@link</font> http://xmlrpc-epi.sourceforge.net/specs/rfc.fault_codes.php Dan&amp;nbsp;Libby's&amp;nbsp;specifications.</font>
<font color='#555555'>;;</font>
<font color='#555555'>;; The server is used by registering &lt;handler&gt; functions that handle requests to</font>
<font color='#555555'>;; a specific path. Only one introspection function, &lt;system.listMethods&gt;, is included.</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;h4&gt;Version history&lt;/h4&gt;</font>
<font color='#555555'>;; &lt;b&gt;1.1&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; updated for newlisp 10</font>
<font color='#555555'>;; &amp;bull; updated to use element module for faster xml serialization</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;1.0&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; initial release</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (load "xmlrpc-server.lsp")</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; (define (get-time)</font>
<font color='#555555'>;;   (date (date-value)))</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; (Xmlrpc-server:add-to-registry "myapp.getTime" get-time)</font>
<font color='#555555'>;; (Xmlrpc-server:run-server 8080 "/RPC2")</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> 'Xmlrpc-server<font color='#AA0000'>)</font>

<font color='#555555'>;;; Error codes</font>
<font color='#AA0000'>(</font><font color='#0000AA'>constant</font>
  'NOT-WELL-FORMED <font color='#665500'>-32700</font>
  'INVALID-XML-RPC <font color='#665500'>-32600</font>
  'METHOD-NOT-FOUND <font color='#665500'>-3260</font>
  'INVALID-PARAMETERS <font color='#665500'>-32602</font>
  'APPLICATION-ERROR <font color='#665500'>-32500</font>
  'SERVER-ERROR <font color='#665500'>-32603</font>
  'OTHER-ERROR <font color='#665500'>-32099</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>setf</font> error-codes
  '<font color='#AA0000'>(</font><font color='#AA0000'>(</font>NOT-WELL-FORMED <font color='#AA0000'>(</font><font color='#665500'>-32700</font> <font color='#008800'>"Parse error: XML not well formed"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font>INVALID-XML-RPC <font color='#AA0000'>(</font><font color='#665500'>-32600</font> <font color='#008800'>"Parse error: Invalid XML-RPC"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font>METHOD-NOT-FOUND <font color='#AA0000'>(</font><font color='#665500'>-32601</font> <font color='#008800'>"Server error: Method not found"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font>INVALID-PARAMETERS <font color='#AA0000'>(</font><font color='#665500'>-32602</font> <font color='#008800'>"Server error: Invalid method parameters"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font>APPLICATION-ERROR <font color='#AA0000'>(</font><font color='#665500'>-32500</font> <font color='#008800'>"Application error"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font>SERVER-ERROR <font color='#AA0000'>(</font><font color='#665500'>-32400</font> <font color='#008800'>"Server error"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font>OTHER-ERROR <font color='#AA0000'>(</font><font color='#665500'>-32099</font> <font color='#008800'>"An error has occurred"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;; Parsing XML-RPC into Lisp expressions</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>parse-request xml , old-type-tags parsed call<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> old-type-tags <font color='#AA0000'>(</font><font color='#0000AA'>xml-type-tags</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>xml-type-tags</font> <font color='#0000AA'>nil</font> <font color='#0000AA'>nil</font> <font color='#0000AA'>nil</font> <font color='#0000AA'>nil</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> parsed <font color='#AA0000'>(</font><font color='#0000AA'>xml-parse</font> xml <font color='#AA0000'>(</font><font color='#0000AA'>+</font> <font color='#665500'>1</font> <font color='#665500'>2</font> <font color='#665500'>4</font> <font color='#665500'>8</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>apply</font> <font color='#0000AA'>xml-type-tags</font> old-tags<font color='#AA0000'>)</font>
  
  <font color='#AA0000'>(</font><font color='#0000AA'>when</font> <font color='#AA0000'>(</font><font color='#0000AA'>or</font> <font color='#AA0000'>(</font><font color='#0000AA'>xml-error</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>not</font> <font color='#AA0000'>(</font><font color='#0000AA'>assoc</font> 'methodCall parsed<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>throw-error</font> <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>xml-error</font><font color='#AA0000'>)</font> NOT-WELL-FORMED INVALID-XML-RPC<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> call <font color='#AA0000'>(</font><font color='#0000AA'>rest</font> <font color='#AA0000'>(</font><font color='#0000AA'>assoc</font> 'methodCall parsed<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>list</font> <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> 'methodName call<font color='#AA0000'>)</font>
        <font color='#AA0000'>(</font><font color='#0000AA'>map</font> xmlrpc->lisp <font color='#AA0000'>(</font><font color='#0000AA'>rest</font> <font color='#AA0000'>(</font><font color='#0000AA'>assoc</font> 'params call<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>xmlrpc-value->lisp value <font color='#AA0000'>(</font>type-param <font color='#0000AA'>string</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>case</font> type-param
    <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#AA0000'>(</font>XML:decode <font color='#AA0000'>(</font><font color='#0000AA'>string</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font>i4 <font color='#AA0000'>(</font><font color='#0000AA'>int</font> value <font color='#665500'>0</font> <font color='#665500'>10</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>int</font> <font color='#AA0000'>(</font><font color='#0000AA'>int</font> value <font color='#665500'>0</font> <font color='#665500'>10</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font>double <font color='#AA0000'>(</font><font color='#0000AA'>float</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font>boolean <font color='#AA0000'>(</font><font color='#0000AA'>=</font> <font color='#008800'>"1"</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font>base64 <font color='#AA0000'>(</font><font color='#0000AA'>base64-dec</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>true</font> <font color='#AA0000'>(</font>XML:decode <font color='#AA0000'>(</font><font color='#0000AA'>string</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>xmlrpc->lisp expr , m<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>cond</font>
    <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>setf</font> m <font color='#AA0000'>(</font><font color='#0000AA'>match</font> '<font color='#AA0000'>(</font>param <font color='#AA0000'>(</font>value <font color='#AA0000'>(</font>? ?<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> expr<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
     <font color='#AA0000'>(</font>xmlrpc-value->lisp <font color='#AA0000'>(</font>m <font color='#665500'>1</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>m <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>setf</font> m <font color='#AA0000'>(</font><font color='#0000AA'>match</font> '<font color='#AA0000'>(</font>param <font color='#AA0000'>(</font>value ?<font color='#AA0000'>)</font><font color='#AA0000'>)</font> expr<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
     <font color='#AA0000'>(</font>xmlrpc-value->lisp <font color='#AA0000'>(</font>m <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>setf</font> m <font color='#AA0000'>(</font><font color='#0000AA'>match</font> '<font color='#AA0000'>(</font>param <font color='#AA0000'>(</font><font color='#0000AA'>array</font> <font color='#AA0000'>(</font>data <font color='#0000AA'>*</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> expr<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
     <font color='#AA0000'>(</font><font color='#0000AA'>map</font> 'xmlrpc->lisp <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>list</font> <font color='#AA0000'>(</font><font color='#0000AA'>dup</font> 'param <font color='#AA0000'>(</font><font color='#0000AA'>length</font> <font color='#AA0000'>(</font>m <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>m <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>setf</font> m <font color='#AA0000'>(</font><font color='#0000AA'>match</font> '<font color='#AA0000'>(</font>param <font color='#AA0000'>(</font>struct <font color='#0000AA'>*</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> expr<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
     <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#AA0000'>(</font>fn <font color='#AA0000'>(</font>x<font color='#AA0000'>)</font>
            <font color='#AA0000'>(</font><font color='#0000AA'>list</font> <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> 'name x<font color='#AA0000'>)</font>
                  <font color='#AA0000'>(</font>xmlrpc->lisp <font color='#AA0000'>(</font><font color='#0000AA'>list</font> 'param <font color='#AA0000'>(</font><font color='#0000AA'>assoc</font> <font color='#AA0000'>(</font>x 'value<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
          <font color='#AA0000'>(</font>m <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>true</font> <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#008800'>"???: "</font> expr<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;; Generating XML-RPC from Lisp expressions</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>array->xmlrpc e<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>list->xmlrpc <font color='#AA0000'>(</font><font color='#0000AA'>array-list</font> e<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>list->xmlrpc e<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>Element <font color='#008800'>"array"</font> <font color='#0000AA'>nil</font>
    <font color='#AA0000'>(</font>Element <font color='#008800'>"data"</font> <font color='#0000AA'>nil</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>join</font> <font color='#AA0000'>(</font><font color='#0000AA'>map</font> lisp->value e<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>context->xmlrpc e<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>Element <font color='#008800'>"struct"</font> <font color='#0000AA'>nil</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#AA0000'>(</font>fn <font color='#AA0000'>(</font>key<font color='#AA0000'>)</font>
           <font color='#AA0000'>(</font>Element <font color='#008800'>"member"</font> <font color='#0000AA'>nil</font>
             <font color='#AA0000'>(</font>Element <font color='#008800'>"name"</font> <font color='#0000AA'>nil</font> key<font color='#AA0000'>)</font>
             <font color='#AA0000'>(</font>lisp->value <font color='#AA0000'>(</font>e key<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
         <font color='#AA0000'>(</font>keys e<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>lisp->value expr<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>case</font> <font color='#AA0000'>(</font>type-of expr<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#008800'>"integer"</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"value"</font> <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"int"</font> <font color='#0000AA'>nil</font> expr<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#008800'>"float"</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"value"</font> <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"double"</font> <font color='#0000AA'>nil</font> expr<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#008800'>"boolean"</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"value"</font> <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"boolean"</font> <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>true?</font> expr<font color='#AA0000'>)</font> <font color='#665500'>1</font> <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#008800'>"array"</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"value"</font> <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font>array->xmlrpc expr<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#008800'>"list"</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"value"</font> <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font>list->xmlrpc expr<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#008800'>"context"</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"value"</font> <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font>context->xmlrpc expr<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#008800'>"symbol"</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"value"</font> <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"string"</font> <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font>Element:encode <font color='#AA0000'>(</font>name expr<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>true</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"value"</font> <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"string"</font> <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font>Element:encode expr<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>lisp->xmlrpc-params expr<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>Element <font color='#008800'>"params"</font> <font color='#0000AA'>nil</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>atom?</font> expr<font color='#AA0000'>)</font>
        <font color='#AA0000'>(</font>Element <font color='#008800'>"param"</font> <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font>lisp->value expr<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
        <font color='#AA0000'>(</font><font color='#0000AA'>apply</font> 'string <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#AA0000'>(</font>fn <font color='#AA0000'>(</font>v<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"param"</font> <font color='#0000AA'>nil</font> v<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
                            <font color='#AA0000'>(</font><font color='#0000AA'>map</font> lisp->value expr<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>response str<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>Element:doc <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"methodResponse"</font> <font color='#0000AA'>nil</font> str<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;; Faults</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>fault code msg<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if-not</font> msg <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> msg <font color='#AA0000'>(</font><font color='#0000AA'>or</font> <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> code error-codes<font color='#AA0000'>)</font> <font color='#008800'>"Unknown error"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>response
    <font color='#AA0000'>(</font>Element <font color='#008800'>"fault"</font> <font color='#0000AA'>nil</font>
      <font color='#AA0000'>(</font>Element <font color='#008800'>"value"</font> <font color='#0000AA'>nil</font>
        <font color='#AA0000'>(</font>Element <font color='#008800'>"struct"</font> <font color='#0000AA'>nil</font>
          <font color='#AA0000'>(</font>Element <font color='#008800'>"member"</font> <font color='#0000AA'>nil</font>
            <font color='#AA0000'>(</font>Element <font color='#008800'>"name"</font> <font color='#0000AA'>nil</font> <font color='#008800'>"faultCode"</font><font color='#AA0000'>)</font>
            <font color='#AA0000'>(</font>Element <font color='#008800'>"value"</font> <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"int"</font> <font color='#0000AA'>nil</font> code<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
          <font color='#AA0000'>(</font>Element <font color='#008800'>"member"</font> <font color='#0000AA'>nil</font>
            <font color='#AA0000'>(</font>Element <font color='#008800'>"name"</font> <font color='#0000AA'>nil</font> <font color='#008800'>"faultString"</font><font color='#AA0000'>)</font>
            <font color='#AA0000'>(</font>Element <font color='#008800'>"value"</font> <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font>Element <font color='#008800'>"string"</font> <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font>Element:encode msg<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;; Registration of functions</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (Xmlrpc-server:add-to-registry &lt;str-path&gt; &lt;lambda-func&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-path&gt; the path which will respond to the passed function</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;lambda-func&gt; the function which will be applied to requests on &lt;str-path&gt;</font>
<font color='#555555'>;; &lt;p&gt;Registers a function to respond when requests are sent to &lt;str-path&gt;. The function</font>
<font color='#555555'>;; will be passed a lisp representation of the XML-RPC request.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setf</font> registry '<font color='#AA0000'>(</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>add-to-registry key func<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>push</font> <font color='#AA0000'>(</font><font color='#0000AA'>list</font> <font color='#AA0000'>(</font><font color='#0000AA'>string</font> key<font color='#AA0000'>)</font> func<font color='#AA0000'>)</font> registry <font color='#665500'>-1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>registered key<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> key registry<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;; Xmlrpc response handler</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>response-handler request-xml , req fun res<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if-not</font> <font color='#AA0000'>(</font><font color='#0000AA'>catch</font> <font color='#AA0000'>(</font>parse-request request-xml<font color='#AA0000'>)</font> 'req<font color='#AA0000'>)</font>
    <font color='#555555'>;; parse error</font>
    <font color='#AA0000'>(</font>fault req<font color='#AA0000'>)</font>
    <font color='#555555'>;; valid xml-rpc</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>if-not</font> <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> fun <font color='#AA0000'>(</font>registered <font color='#AA0000'>(</font><font color='#0000AA'>first</font> req<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
      <font color='#555555'>;; method not found</font>
      <font color='#AA0000'>(</font>fault METHOD-NOT-FOUND <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#008800'>"Method not found: "</font> <font color='#AA0000'>(</font><font color='#0000AA'>first</font> req<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
      <font color='#555555'>;; valid method</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>if-not</font> <font color='#AA0000'>(</font><font color='#0000AA'>catch</font> <font color='#AA0000'>(</font><font color='#0000AA'>apply</font> fun <font color='#AA0000'>(</font>req <font color='#665500'>1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> 'res<font color='#AA0000'>)</font>
        <font color='#555555'>;; error in function</font>
        <font color='#AA0000'>(</font>fault APPLICATION-ERROR <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#008800'>"Application error: "</font> <font color='#AA0000'>(</font><font color='#0000AA'>first</font> <font color='#AA0000'>(</font><font color='#0000AA'>parse</font> res <font color='#008800'>"&#092;n"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
        <font color='#555555'>;; valid response</font>
        <font color='#AA0000'>(</font><font color='#0000AA'>if-not</font> <font color='#AA0000'>(</font><font color='#0000AA'>catch</font> <font color='#AA0000'>(</font>lisp->xmlrpc-params res<font color='#AA0000'>)</font> 'res<font color='#AA0000'>)</font>
          <font color='#555555'>;; server error when translating to xmlrpc params</font>
          <font color='#AA0000'>(</font>fault SERVER-ERROR res<font color='#AA0000'>)</font>
          <font color='#555555'>;; valid response</font>
          <font color='#AA0000'>(</font>response res<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>handler request , http res<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>catch</font>
        <font color='#AA0000'>(</font><font color='#0000AA'>begin</font>
          <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> http <font color='#AA0000'>(</font>Http:parse-request request<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
          <font color='#AA0000'>(</font><font color='#0000AA'>when</font> <font color='#AA0000'>(</font><font color='#0000AA'>and</font> <font color='#AA0000'>(</font><font color='#0000AA'>=</font> <font color='#008800'>"POST"</font> <font color='#AA0000'>(</font><font color='#0000AA'>upper-case</font> <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> <font color='#008800'>"method"</font> http<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
                     <font color='#AA0000'>(</font><font color='#0000AA'>=</font> server-path <font color='#AA0000'>(</font><font color='#0000AA'>trim</font> <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> <font color='#008800'>"path"</font> http<font color='#AA0000'>)</font> <font color='#008800'>""</font> <font color='#008800'>"/"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
              <font color='#AA0000'>(</font><font color='#0000AA'>let</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>resp <font color='#AA0000'>(</font>response-handler <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> <font color='#008800'>"content"</font> http<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
                <font color='#AA0000'>(</font>Http:format-response resp <font color='#665500'>200</font> <font color='#008800'>"text/xml"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
        'res<font color='#AA0000'>)</font>
      res
      <font color='#AA0000'>(</font>Http:format-response
        <font color='#AA0000'>(</font>fault SERVER-ERROR <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#008800'>"Server error: "</font> res<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
        <font color='#665500'>200</font> <font color='#008800'>"text/xml"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (Xmlrpc-server:run-server [&lt;int-port&gt; [&lt;str-path&gt;]])</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;int-port&gt; port on which to listen; defaults to 8080</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-path&gt; path on which to response; defaults to "/RPC2"</font>
<font color='#555555'>;; &lt;p&gt;Initializes and starts server. Server will block if-not started in a</font>
<font color='#555555'>;; child process.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setf</font> server-path <font color='#008800'>"/RPC2"</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>run-server <font color='#AA0000'>(</font>port <font color='#665500'>8080</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>path <font color='#008800'>"/RPC2"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> server-path path<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> SocketServer:handler handler<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>println</font> <font color='#008800'>"Starting server"</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>SocketServer:serve port<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;; Introspection methods (partially implemented)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>system-listMethods<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>list</font> <font color='#AA0000'>(</font><font color='#0000AA'>map</font> 'string <font color='#AA0000'>(</font><font color='#0000AA'>map</font> 'first registry<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font>add-to-registry <font color='#008800'>"system.listMethods"</font> system-listMethods<font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> MAIN<font color='#AA0000'>)</font>


</pre><center><font face='Arial' size='-3' color='#666666'>syntax highlighting with <a href="http://newlisp.org">newLISP</a>&nbsp;and <a href="http://newlisp.org/newLISPdoc.html">newLISPdoc</a></font></center></body></html>
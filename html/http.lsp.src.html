<!DOCTYPE HTML PUBLIC "4.01 Transitional"><html><title>Http</title><body><pre>
<font color='#555555'>;; <font color='#308080'>@module</font> Http</font>
<font color='#555555'>;; <font color='#308080'>@author</font> Jeff Ober &lt;jeffober@gmail.com&gt;</font>
<font color='#555555'>;; <font color='#308080'>@version</font> 1.1</font>
<font color='#555555'>;; <font color='#308080'>@location</font> http://static.artfulcode.net/newlisp/http.lsp</font>
<font color='#555555'>;; <font color='#308080'>@package</font> http://static.artfulcode.net/newlisp/http.qwerty</font>
<font color='#555555'>;; <font color='#308080'>@description</font> A bare-bones HTTP 1.0 library (updated for newlisp 10).</font>
<font color='#555555'>;; Http is an extremely bare-bones HTTP 1.0 library. Not all functionality</font>
<font color='#555555'>;; is implemented. In particular, the ability to parse an HTTP response is not</font>
<font color='#555555'>;; yet finished, but the ability to parse requests and send both requests and</font>
<font color='#555555'>;; responses is finished.</font>
<font color='#555555'>;; This module has not been rigorously tested. Your mileage may vary. Requires</font>
<font color='#555555'>;; newlisp 10.</font>
<font color='#555555'>;; &lt;h4&gt;Version history&lt;/h4&gt;</font>
<font color='#555555'>;; &lt;b&gt;1.1&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; updated for newlisp 10</font>
<font color='#555555'>;; &amp;bull; code clean-up</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;1.0&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; initial release</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> 'Http<font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'request-init-re <font color='#AA0000'>(</font><font color='#0000AA'>regex-comp</font> <font color='#008800'>{^(GET|POST|HEAD|PUT) (.+?) HTTP/(1.\d)$}</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'request-header-re <font color='#AA0000'>(</font><font color='#0000AA'>regex-comp</font> <font color='#008800'>{^(.+?):\s+(.+?)$}</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'line-ending-re <font color='#AA0000'>(</font><font color='#0000AA'>regex-comp</font> <font color='#008800'>[text][\r\n]{2,4}[/text]</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'response-template <font color='#008800'>"HTTP/1.0 %d OK&#092;r&#092;nConnection: close&#092;r&#092;nContent-Type: %s&#092;r&#092;nDate: %s&#092;r&#092;nContent-Length: %d%s&#092;r&#092;n&#092;r&#092;n%s"</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>format-header pair<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>format</font> <font color='#008800'>"%s: %s"</font> <font color='#AA0000'>(</font><font color='#0000AA'>title-case</font> <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#AA0000'>(</font>pair <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#AA0000'>(</font>pair <font color='#665500'>1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (Http:parse-request &lt;str-request&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-request&gt; an HTTP request received</font>
<font color='#555555'>;; &lt;p&gt;Parses an HTTP request and returns an association list.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (parse-request</font>
<font color='#555555'>;;   (format-request "POST"</font>
<font color='#555555'>;;                   "/cgi-bin/post_comment.cgi"</font>
<font color='#555555'>;;                   '(("Host" "www.somesite.com"))</font>
<font color='#555555'>;;                   "name=Some+Person&amp;comment=Hello+world!"))</font>
<font color='#555555'>;;</font>
<font color='#555555'>;; => (("method" "POST")</font>
<font color='#555555'>;;     ("path" "/cgi-bin/post_comment.cgi")</font>
<font color='#555555'>;;     ("http-version" "1.0")</font>
<font color='#555555'>;;     ("headers" (("host" "www.somesite.com")</font>
<font color='#555555'>;;                 ("content-length" "37") nil)) </font>
<font color='#555555'>;;     ("content" ""))</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>parse-request req , lines request headers<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>when</font> <font color='#AA0000'>(</font><font color='#0000AA'>and</font> <font color='#AA0000'>(</font><font color='#0000AA'>string?</font> req<font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>not</font> <font color='#AA0000'>(</font><font color='#0000AA'>empty?</font> req<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> lines <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>trim</font> <font color='#AA0000'>(</font><font color='#0000AA'>parse</font> req line-ending-re <font color='#665500'>0x10000</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> headers '<font color='#AA0000'>(</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> request
      <font color='#AA0000'>(</font><font color='#0000AA'>first</font> <font color='#AA0000'>(</font><font color='#0000AA'>find-all</font> request-init-re <font color='#AA0000'>(</font><font color='#0000AA'>first</font> lines<font color='#AA0000'>)</font>
               <font color='#AA0000'>(</font><font color='#0000AA'>list</font> <font color='#AA0000'>(</font><font color='#0000AA'>list</font> <font color='#008800'>"method"</font> $1<font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>list</font> <font color='#008800'>"path"</font> $2<font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>list</font> <font color='#008800'>"http-version"</font> $3<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
               <font color='#665500'>0x10000</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>when</font> request
      <font color='#AA0000'>(</font><font color='#0000AA'>dolist</font> <font color='#AA0000'>(</font>line <font color='#AA0000'>(</font><font color='#0000AA'>slice</font> lines <font color='#665500'>1</font> <font color='#665500'>-1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
        <font color='#AA0000'>(</font><font color='#0000AA'>push</font> <font color='#AA0000'>(</font><font color='#0000AA'>first</font> <font color='#AA0000'>(</font><font color='#0000AA'>find-all</font> request-header-re line <font color='#AA0000'>(</font><font color='#0000AA'>list</font> <font color='#AA0000'>(</font><font color='#0000AA'>lower-case</font> $1<font color='#AA0000'>)</font> $2<font color='#AA0000'>)</font> <font color='#665500'>0x10000</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
          headers <font color='#665500'>-1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>push</font> <font color='#AA0000'>(</font><font color='#0000AA'>list</font> <font color='#008800'>"headers"</font> headers<font color='#AA0000'>)</font> request <font color='#665500'>-1</font><font color='#AA0000'>)</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>push</font> <font color='#AA0000'>(</font><font color='#0000AA'>list</font> <font color='#008800'>"content"</font> <font color='#AA0000'>(</font><font color='#0000AA'>slice</font> <font color='#AA0000'>(</font><font color='#0000AA'>last</font> lines<font color='#AA0000'>)</font> <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> request <font color='#665500'>-1</font><font color='#AA0000'>)</font>
      request<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (Http:format-response &lt;str-response&gt; [&lt;int-code&gt; [&lt;str-content-type&gt; [&lt;assoc-headers&gt;]]])</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-response&gt; the text of the HTTP response</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;int-code&gt; the HTTP response code; default is 200 (success)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-content-type&gt; MIME type of response; default is "text/html"</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;assoc-headers&gt; association list of headers to add to response</font>
<font color='#555555'>;; &lt;p&gt;Formats an HTTP/1.0 response.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (format-response binary-file-content 200 "audio/mp3")</font>
<font color='#555555'>;; => "HTTP/1.0 200 OK&#092;r&#092;nConnection: close&#092;r&#092;nContent-Type: audio/mp3&#092;r&#092;nDate: Tue, 08 Jul 2008 10:30:09 EDT&#092;r&#092;nContent-Length: 17&#092;r&#092;n&#092;r&#092;n11000101010101..."</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>format-response response <font color='#AA0000'>(</font>code <font color='#665500'>200</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>content-type <font color='#008800'>"text/html"</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>extra-headers '<font color='#AA0000'>(</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>format</font> response-template
          code
          content-type
		      <font color='#AA0000'>(</font><font color='#0000AA'>date</font> <font color='#AA0000'>(</font><font color='#0000AA'>date-value</font><font color='#AA0000'>)</font> <font color='#665500'>0</font> <font color='#008800'>"%a, %d %b %Y %H:%M:%S %Z"</font><font color='#AA0000'>)</font>
		      <font color='#AA0000'>(</font><font color='#0000AA'>length</font> response<font color='#AA0000'>)</font>
		      <font color='#AA0000'>(</font><font color='#0000AA'>if-not</font> <font color='#AA0000'>(</font><font color='#0000AA'>empty?</font> extra-headers<font color='#AA0000'>)</font>
				    <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#008800'>"&#092;r&#092;n"</font> <font color='#AA0000'>(</font><font color='#0000AA'>join</font> <font color='#AA0000'>(</font><font color='#0000AA'>map</font> format-header extra-headers<font color='#AA0000'>)</font> <font color='#008800'>"&#092;r&#092;n"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
				    <font color='#008800'>""</font><font color='#AA0000'>)</font>
		      response<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (Http:format-request &lt;str-method&gt; [&lt;str-path&gt; [&lt;assoc-headers&gt; [&lt;str-content&gt;]]])</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-method&gt; request method (GET, POST, HEAD, or PUT)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-path&gt; request path; default is "/"</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;assoc-headers&gt; association list of headers to add to request</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-content&gt; for POST and PUT methods, string containing request content</font>
<font color='#555555'>;; &lt;p&gt;Formats an appropriate HTTP/1.0 request. Note that the "Host" header must be added explicitly if required.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (format-request "POST"</font>
<font color='#555555'>;;                 "/cgi-bin/post_comment.cgi"</font>
<font color='#555555'>;;                 '(("Host" "www.somesite.com"))</font>
<font color='#555555'>;;                 "name=Some+Person&amp;comment=Hello+world!"))</font>
<font color='#555555'>;; => "HTTP/1.0 200 OK&#092;r&#092;nConnection: close&#092;r&#092;nContent-Type: text/html&#092;r&#092;nDate: Tue, 08 Jul 2008 10:28:03 EDT&#092;r&#092;nContent-Length: 46&#092;r&#092;n&#092;r&#092;n&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello world&lt;/h2&gt;&lt;/body&gt;&lt;/html&gt;"</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>format-request method <font color='#AA0000'>(</font>path <font color='#008800'>"/"</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>headers '<font color='#AA0000'>(</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> content, <font color='#AA0000'>(</font>buf <font color='#008800'>""</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if-not</font> <font color='#AA0000'>(</font><font color='#0000AA'>and</font> <font color='#AA0000'>(</font><font color='#0000AA'>string?</font> method<font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>find</font> <font color='#AA0000'>(</font><font color='#0000AA'>upper-case</font> method<font color='#AA0000'>)</font> '<font color='#AA0000'>(</font><font color='#008800'>"GET"</font> <font color='#008800'>"POST"</font> <font color='#008800'>"HEAD"</font> <font color='#008800'>"PUT"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
	  <font color='#AA0000'>(</font><font color='#0000AA'>throw-error</font> <font color='#008800'>"Invalid or unimplemented HTTP method"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> method <font color='#AA0000'>(</font><font color='#0000AA'>upper-case</font> method<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>write-buffer</font> buf <font color='#AA0000'>(</font><font color='#0000AA'>format</font> <font color='#008800'>"%s %s HTTP/1.0&#092;r&#092;n"</font> method <font color='#AA0000'>(</font><font color='#0000AA'>string</font> path<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>dolist</font> <font color='#AA0000'>(</font>header headers<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>write-buffer</font> buf <font color='#AA0000'>(</font><font color='#0000AA'>format</font> <font color='#008800'>"%s&#092;r&#092;n"</font> <font color='#AA0000'>(</font>format-header header<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>when</font> content
		<font color='#AA0000'>(</font><font color='#0000AA'>write-buffer</font> buf <font color='#AA0000'>(</font><font color='#0000AA'>format</font> <font color='#008800'>"Content-Length: %d&#092;r&#092;n&#092;r&#092;n"</font> <font color='#AA0000'>(</font><font color='#0000AA'>length</font> content<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
		<font color='#AA0000'>(</font><font color='#0000AA'>write-buffer</font> buf content<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>write-buffer</font> buf <font color='#008800'>"&#092;r&#092;n&#092;r&#092;n"</font><font color='#AA0000'>)</font>
  buf<font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> MAIN<font color='#AA0000'>)</font>

</pre><center><font face='Arial' size='-3' color='#666666'>syntax highlighting with <a href="http://newlisp.org">newLISP</a>&nbsp;and <a href="http://newlisp.org/newLISPdoc.html">newLISPdoc</a></font></center></body></html>
<!DOCTYPE HTML PUBLIC "4.01 Transitional"><html><title>matching</title><body><pre>
<font color='#555555'>;; <font color='#308080'>@module</font> matching</font>
<font color='#555555'>;; <font color='#308080'>@author</font> Jeff Ober &lt;jeffober@gmail.com&gt;</font>
<font color='#555555'>;; <font color='#308080'>@version</font> 1.0</font>
<font color='#555555'>;; <font color='#308080'>@location</font> http://static.artfulcode.net/newlisp/matching.lsp</font>
<font color='#555555'>;; <font color='#308080'>@package</font> http://static.artfulcode.net/newlisp/matching.qwerty</font>
<font color='#555555'>;; <font color='#308080'>@description</font> Complex conditionals using match and unify (updated for newlisp 10)</font>
<font color='#555555'>;; &lt;p&gt;Matching conditionals make possible a very terse style of programming common to the</font>
<font color='#555555'>;; ML family of languages.&lt;/p&gt;</font>
<font color='#555555'>;; &lt;h4&gt;Version history&lt;/h4&gt;</font>
<font color='#555555'>;; &lt;b&gt;1.0&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; updated for newlisp 10</font>
<font color='#555555'>;; &amp;bull; renamed module to matching</font>
<font color='#555555'>;; &amp;bull; removed dependency on util.lsp</font>
<font color='#555555'>;; &amp;bull; made match-bind a global symbol</font>
<font color='#555555'>;; &amp;bull; fixed error in documentation for match-cond</font>
<font color='#555555'>;; &amp;bull; fixed error in match-cond that bound arguments incorrectly</font>
<font color='#555555'>;; &amp;bull; removed match-with and if-match because they were generally confusing and unnecessary</font>
<font color='#555555'>;; &amp;bull; match-bind no longer binds exact matches (e.g. 'foo and 'foo), only wildcards</font>
<font color='#555555'>;; &amp;bull; fixed bug in match-case where target was bound incorrectly in some cases</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;0.5&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; fixed bug in 'with-match' causing $0 to be misinterpreted in certain circumstances</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;0.4&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; added 'with-match', a simpler operator that is more idiomatic of newLISP</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;0.3&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; added 'if-match', 'match-with'</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;0.2&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; altered argument order in 'match-cond'</font>
<font color='#555555'>;; &amp;bull; added 'match-case'</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;0.1&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; initial release</font>
<font color='#555555'>;; &amp;bull; added 'match-bind', 'match-let'</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (match-bind &lt;vars&gt; &lt;pattern&gt; &lt;target&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;vars&gt; symbols to bind</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;pattern&gt; match pattern</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;target&gt; match target</font>
<font color='#555555'>;; &lt;p&gt;If '(match &lt;pattern&gt; &lt;target&gt;)' is valid, binds &lt;vars&gt; to</font>
<font color='#555555'>;; the result of its evaluation.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (match-bind '(a b) '(? ?) '(1 2))</font>
<font color='#555555'>;; a => 1</font>
<font color='#555555'>;; b => 2</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>match-bind var-list pattern target<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>let</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>m <font color='#AA0000'>(</font><font color='#0000AA'>match</font> pattern target<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>set</font> var-list m<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>global</font> 'match-bind<font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (match-let (&lt;vars&gt; &lt;pattern&gt; &lt;target&gt;) &lt;body&gt; ...)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;vars&gt; symbols to bind</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;pattern&gt; match pattern</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;target&gt; match target</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;body&gt; series of forms to be evaluated</font>
<font color='#555555'>;; &lt;p&gt;'match-let' will evaluate body in an environment where</font>
<font color='#555555'>;; variables &lt;vars&gt; are bound to the destructured values from</font>
<font color='#555555'>;; &lt;target&gt; according to match pattern &lt;pattern&gt;.  Thus, if</font>
<font color='#555555'>;; the result of '(match &lt;pattern&gt; &lt;target&gt;)' is '(1 2 (3 4))',</font>
<font color='#555555'>;; &lt;vars&gt; '(a b c)' will be bound as '((a 1) (b 2) (c '(3 4)))'.&lt;/p&gt;</font>
<font color='#555555'>;; &lt;p&gt;Should &lt;pattern&gt; not match &lt;target&gt;, an error is signaled.</font>
<font color='#555555'>;; Note that &lt;target&gt; is evaluated before &lt;body&gt; is executed.</font>
<font color='#555555'>;; &lt;target&gt; is evaluated even if the match fails, as it is the</font>
<font color='#555555'>;; evaluated form against which &lt;pattern&gt; is matched.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (let ((lst '(1 2 3 4)))</font>
<font color='#555555'>;;   (match-let ((a b c) (? ? *) lst)</font>
<font color='#555555'>;;     (+ a b (apply * c))))</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; => 15</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define-macro</font> <font color='#AA0000'>(</font>match-let<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>letex</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>var-list <font color='#AA0000'>(</font><font color='#0000AA'>args</font> <font color='#665500'>0</font> <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
          <font color='#AA0000'>(</font>pattern <font color='#AA0000'>(</font><font color='#0000AA'>args</font> <font color='#665500'>0</font> <font color='#665500'>1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
          <font color='#AA0000'>(</font>target <font color='#AA0000'>(</font><font color='#0000AA'>args</font> <font color='#665500'>0</font> <font color='#665500'>2</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
          <font color='#AA0000'>(</font>body <font color='#AA0000'>(</font><font color='#0000AA'>cons</font> 'begin <font color='#AA0000'>(</font><font color='#0000AA'>rest</font> <font color='#AA0000'>(</font><font color='#0000AA'>args</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>match</font> 'pattern target<font color='#AA0000'>)</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>local</font> var-list
        <font color='#AA0000'>(</font>match-bind 'var-list 'pattern target<font color='#AA0000'>)</font>
        body<font color='#AA0000'>)</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>throw-error</font> <font color='#008800'>"no match possible"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>global</font> 'match-let<font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (match-case &lt;target&gt; (&lt;case-pattern&gt; &lt;case-vars&gt; &lt;case-expr&gt;) ...)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;target&gt; the expression to match against</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;case-pattern&gt; the pattern to match with &lt;target&gt;</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;case-vars&gt; the symbols to bind to the result of the match</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;case-expr&gt; the form to be evaluated should &lt;case-pattern&gt; match successfully</font>
<font color='#555555'>;; &lt;p&gt;'match-case' tries a series of match cases in sequence and returns the result of </font>
<font color='#555555'>;; evaluating the first successful match's &lt;case-expr&gt; in a local scope in which symbols</font>
<font color='#555555'>;; &lt;case-vars&gt; are bound to the result of matching &lt;case-pattern&gt; against &lt;target&gt;.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (let ((x '(1 2 3 4 5)))</font>
<font color='#555555'>;;   (match-case x</font>
<font color='#555555'>;;     ((? ? ?) (a b c) (println "this form is not evaluated since '(? ? ?) does not match x"))</font>
<font color='#555555'>;;     ((? ? *) (a b c) (println "c is bound to " c " in this form"))</font>
<font color='#555555'>;;     ((*) (a) (println "catch-all")))) ; (*) matches all lists, so it is catch-all for x</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; => "c is bound to (3 4 5) in this form"</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define-macro</font> <font color='#AA0000'>(</font>match-case<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>let</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>target <font color='#AA0000'>(</font><font color='#0000AA'>args</font> <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>catch</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>dolist</font> <font color='#AA0000'>(</font>form <font color='#AA0000'>(</font><font color='#0000AA'>rest</font> <font color='#AA0000'>(</font><font color='#0000AA'>args</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
        <font color='#AA0000'>(</font><font color='#0000AA'>letex</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>tgt <font color='#AA0000'>(</font><font color='#0000AA'>eval</font> target<font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>pattern <font color='#AA0000'>(</font>form <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>vars <font color='#AA0000'>(</font>form <font color='#665500'>1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>expr <font color='#AA0000'>(</font>form <font color='#665500'>2</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
          <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>match</font> 'pattern 'tgt<font color='#AA0000'>)</font>
            <font color='#AA0000'>(</font>match-let <font color='#AA0000'>(</font>vars pattern 'tgt<font color='#AA0000'>)</font>
              <font color='#AA0000'>(</font><font color='#0000AA'>throw</font> expr<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>global</font> 'match-case<font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (match-cond ((&lt;pattern&gt; &lt;vars&gt; &lt;target&gt;) &lt;body-forms&gt;) ...)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;pattern&gt; match pattern</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;vars&gt; symbols to bind</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;target&gt; match target</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;body&gt; series of forms to be evaluated</font>
<font color='#555555'>;; &lt;p&gt;'match-cond' evaluates a series of match/bind combinations until one</font>
<font color='#555555'>;; of them evaluates non-nil.  The result of the successful match will be bound</font>
<font color='#555555'>;; to the symbols in &lt;vars&gt;, and the associated &lt;body-forms&gt; will be evaluated</font>
<font color='#555555'>;; with those symbols locally bound.  The result of the evaluation is nil if</font>
<font color='#555555'>;; no forms match or the result of the final &lt;body-form&gt; evaluated.&lt;/p&gt;</font>
<font color='#555555'>;; &lt;p&gt;'match-cond' is more versatile than 'match-case' in that 'match-cond' may</font>
<font color='#555555'>;; test against multiple targets and evaluates its &lt;body-forms&gt; in an implicit</font>
<font color='#555555'>;; 'begin' block.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (let ((x '(1 2 3 4 5)))</font>
<font color='#555555'>;;   (match-cond</font>
<font color='#555555'>;;     (((? ? ?) (a b c) x) (println "evaluation never gets here"))</font>
<font color='#555555'>;;     (((? ? *) (a b c) x) (println "c gets bound to " c))</font>
<font color='#555555'>;;     (((*) (a) x) (println "catch-all")))) ; (*) matches all lists, so is catch-all for x</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; => "c gets bound to (3 4 5)"</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define-macro</font> <font color='#AA0000'>(</font>match-cond<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>catch</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>doargs</font> <font color='#AA0000'>(</font>form<font color='#AA0000'>)</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>letex</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>pattern <font color='#AA0000'>(</font>form <font color='#665500'>0</font> <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
              <font color='#AA0000'>(</font>vars <font color='#AA0000'>(</font>form <font color='#665500'>0</font> <font color='#665500'>1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
              <font color='#AA0000'>(</font>target <font color='#AA0000'>(</font>form <font color='#665500'>0</font> <font color='#665500'>2</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
              <font color='#AA0000'>(</font>body <font color='#AA0000'>(</font><font color='#0000AA'>cons</font> 'begin <font color='#AA0000'>(</font><font color='#0000AA'>rest</font> form<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
        <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>match</font> 'pattern target<font color='#AA0000'>)</font>
            <font color='#AA0000'>(</font>match-let <font color='#AA0000'>(</font>vars pattern target<font color='#AA0000'>)</font>
              <font color='#AA0000'>(</font><font color='#0000AA'>throw</font> body<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>global</font> 'match-cond<font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (with-match &lt;target&gt; (&lt;match-form-n&gt; &lt;body-n&gt;) ...)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;target&gt; target of the match</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;match-expr-n&gt; match pattern to be tested against &lt;target&gt;</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;body-n&gt; block to be evaluated if &lt;match-expr-n&gt; matches successfully</font>
<font color='#555555'>;; &lt;p&gt;Tests each &lt;match-expr-n&gt; in turn against &lt;target&gt;.  On the first successful match,</font>
<font color='#555555'>;; the system variable '$0' is bound to the result of the match and the paired &lt;body-n&gt; is</font>
<font color='#555555'>;; evaluated.  No further match forms are tested after a successful match and the result of</font>
<font color='#555555'>;; the evaluation of &lt;body-n&gt; is returned.  If no match is successful, 'nil' is returned.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (with-match '(1 2 3 (4 5))</font>
<font color='#555555'>;;   ((? ? ? (? ?)) (apply + $0))</font>
<font color='#555555'>;;   ((? *) (println "Never gets here")))</font>
<font color='#555555'>;; => 15</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define-macro</font> <font color='#AA0000'>(</font>with-match<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>letex</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>target <font color='#AA0000'>(</font><font color='#0000AA'>args</font> <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>forms <font color='#AA0000'>(</font><font color='#0000AA'>rest</font> <font color='#AA0000'>(</font><font color='#0000AA'>args</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>catch</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>dolist</font> <font color='#AA0000'>(</font>form 'forms<font color='#AA0000'>)</font>
        <font color='#AA0000'>(</font><font color='#0000AA'>letex</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>match-form <font color='#AA0000'>(</font><font color='#0000AA'>first</font> form<font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>body <font color='#AA0000'>(</font><font color='#0000AA'>cons</font> 'begin <font color='#AA0000'>(</font><font color='#0000AA'>rest</font> form<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
          <font color='#AA0000'>(</font><font color='#0000AA'>let</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>$0 <font color='#AA0000'>(</font><font color='#0000AA'>match</font> 'match-form target<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
            <font color='#AA0000'>(</font><font color='#0000AA'>if</font> $0 <font color='#AA0000'>(</font><font color='#0000AA'>throw</font> body<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>global</font> 'with-match<font color='#AA0000'>)</font>


</pre><center><font face='Arial' size='-3' color='#666666'>syntax highlighting with <a href="http://newlisp.org">newLISP</a>&nbsp;and <a href="http://newlisp.org/newLISPdoc.html">newLISPdoc</a></font></center></body></html>
<!DOCTYPE HTML PUBLIC "4.01 Transitional"><html><title>XML</title><body><pre>
<font color='#555555'>;; <font color='#308080'>@module</font> XML</font>
<font color='#555555'>;; <font color='#308080'>@author</font> Jeff Ober &lt;jeffober@gmail.com&gt;</font>
<font color='#555555'>;; <font color='#308080'>@version</font> 2.1</font>
<font color='#555555'>;; <font color='#308080'>@location</font> http://static.artfulcode.net/newlisp/xml.lsp</font>
<font color='#555555'>;; <font color='#308080'>@package</font> http://static.artfulcode.net/newlisp/xml.qwerty</font>
<font color='#555555'>;; <font color='#308080'>@description</font> Parsing and serializing of XML data (updated for newlisp 10).</font>
<font color='#555555'>;; Functions to parse XML text (non-validating) and serialize lisp structures to XML.</font>
<font color='#555555'>;; Requires matching and newlisp 10.</font>
<font color='#555555'>;; &lt;h4&gt;Version history&lt;/h4&gt;</font>
<font color='#555555'>;; &lt;b&gt;2.1&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; code clean-up</font>
<font color='#555555'>;; &amp;bull; updated for newlisp 10</font>
<font color='#555555'>;; &amp;bull; some arguments have changed in lisp->xml and xml->lisp</font>
<font color='#555555'>;; &amp;bull; default encoding is now determined by newlisp UTF-8 compile options</font>
<font color='#555555'>;; &amp;bull; added functions to trim whitespace and decode entities</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;2.0&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; complete rewrite</font>
<font color='#555555'>;; &amp;bull; added XML-compliant entities</font>
<font color='#555555'>;; &amp;bull; automatic serialization of data</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;1.0&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; initial release</font>

<font color='#555555'>;;;============================================================================</font>
<font color='#555555'>;;; XML context</font>
<font color='#555555'>;;;============================================================================</font>
  
<font color='#AA0000'>(</font><font color='#0000AA'>context</font> 'XML<font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'trim-ws-re <font color='#AA0000'>(</font><font color='#0000AA'>regex-comp</font> <font color='#008800'>{(^\s*)|(\s*$)}</font> <font color='#AA0000'>)</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'xml-entity-decode-re <font color='#AA0000'>(</font><font color='#0000AA'>regex-comp</font> <font color='#008800'>"&amp;#(&#092;&#092;d&#123;1,4&#125;)&#059;"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'xml-entity-encode-re <font color='#AA0000'>(</font><font color='#0000AA'>regex-comp</font> <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#008800'>"("</font> <font color='#AA0000'>(</font><font color='#0000AA'>join</font> <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#AA0000'>(</font>fn <font color='#AA0000'>(</font>i<font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>format</font> <font color='#008800'>{\x%x}</font> i<font color='#AA0000'>)</font><font color='#AA0000'>)</font> '<font color='#AA0000'>(</font><font color='#665500'>34</font> <font color='#665500'>38</font> <font color='#665500'>39</font> <font color='#665500'>60</font> <font color='#665500'>62</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#008800'>"|"</font><font color='#AA0000'>)</font> <font color='#008800'>")"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'default-parse-options <font color='#AA0000'>(</font><font color='#0000AA'>+</font> <font color='#665500'>1</font> <font color='#665500'>16</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (XML:trim-whitespace &lt;str&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str&gt; a string</font>
<font color='#555555'>;; &lt;p&gt;Trims all whitespace off both ends of &lt;str&gt;.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>trim-whitespace text<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>replace</font> trim-ws-re text <font color='#008800'>""</font> <font color='#665500'>0x10000</font><font color='#AA0000'>)</font>
  text<font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (XML:decode &lt;str&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str&gt; a string</font>
<font color='#555555'>;; &lt;p&gt;Decodes XML entities and converts them to characters.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>decode str<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>replace</font> xml-entity-decode-re str <font color='#AA0000'>(</font><font color='#0000AA'>char</font> <font color='#AA0000'>(</font><font color='#0000AA'>int</font> $1<font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#665500'>0x10000</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (XML:encode &lt;str&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str&gt; a string</font>
<font color='#555555'>;; &lt;p&gt;Encodes characters in a string to be valid for XML.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>encode str<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>replace</font> xml-entity-encode-re str <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#008800'>"&amp;#"</font> <font color='#AA0000'>(</font><font color='#0000AA'>char</font> $1<font color='#AA0000'>)</font> <font color='#008800'>"&#059;"</font><font color='#AA0000'>)</font> <font color='#665500'>0x10000</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>parse-string text <font color='#AA0000'>(</font>options default-parse-options<font color='#AA0000'>)</font> , old-tags parsed<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> old-tags <font color='#AA0000'>(</font><font color='#0000AA'>xml-type-tags</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>xml-type-tags</font> <font color='#0000AA'>nil</font> <font color='#0000AA'>nil</font> <font color='#0000AA'>nil</font> <font color='#0000AA'>nil</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> parsed <font color='#AA0000'>(</font><font color='#0000AA'>xml-parse</font> text options<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>apply</font> <font color='#0000AA'>xml-type-tags</font> old-tags<font color='#AA0000'>)</font>
  parsed<font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>serialize-attributes attr-list<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>match-let <font color='#AA0000'>(</font><font color='#AA0000'>(</font>attrs<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>@ <font color='#0000AA'>*</font><font color='#AA0000'>)</font> attr-list<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>join</font> <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#AA0000'>(</font>fn <font color='#AA0000'>(</font>pair<font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>format</font> <font color='#008800'>" %s=&#092;&#034;%s&#092;&#034;"</font> <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>string</font> pair<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> attrs<font color='#AA0000'>)</font> <font color='#008800'>""</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>opening-tag node<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>match-let <font color='#AA0000'>(</font><font color='#AA0000'>(</font>tag attr _<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>? ? <font color='#0000AA'>*</font><font color='#AA0000'>)</font> node<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#008800'>"<"</font> tag <font color='#AA0000'>(</font>serialize-attributes attr<font color='#AA0000'>)</font> <font color='#008800'>">"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>closing-tag node<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#008800'>"&lt;/"</font> <font color='#AA0000'>(</font><font color='#0000AA'>first</font> node<font color='#AA0000'>)</font> <font color='#008800'>">"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>empty-tag node<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>match-let <font color='#AA0000'>(</font><font color='#AA0000'>(</font>tag attr _<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>? ? <font color='#0000AA'>*</font><font color='#AA0000'>)</font> node<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#008800'>"<"</font> tag <font color='#AA0000'>(</font>serialize-attributes attr<font color='#AA0000'>)</font> <font color='#008800'>" /&gt;"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>serialize-text-node node<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>match-let <font color='#AA0000'>(</font><font color='#AA0000'>(</font>tag attr text<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>? ? ?<font color='#AA0000'>)</font> node<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#AA0000'>(</font>opening-tag node<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>encode <font color='#AA0000'>(</font>decode text<font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>closing-tag node<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>serialize xml indent? <font color='#AA0000'>(</font>encoding <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#0000AA'>utf8</font> <font color='#008800'>"UTF-8"</font> <font color='#008800'>"ASCII"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>depth <font color='#665500'>0</font><font color='#AA0000'>)</font>, buf<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> buf <font color='#008800'>""</font><font color='#AA0000'>)</font>
  
  <font color='#AA0000'>(</font><font color='#0000AA'>when</font> <font color='#AA0000'>(</font><font color='#0000AA'>zero?</font> depth<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>write-buffer</font> buf <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#008800'>{&lt;?xml version=&#034;1.0&#034; encoding=&#034;}</font> encoding <font color='#008800'>{&#034; ?>}</font> <font color='#008800'>"&#092;n"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> xml <font color='#AA0000'>(</font><font color='#0000AA'>first</font> xml<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  
  <font color='#AA0000'>(</font><font color='#0000AA'>when</font> indent? <font color='#AA0000'>(</font><font color='#0000AA'>write-buffer</font> buf <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#008800'>"&#092;n"</font> <font color='#AA0000'>(</font><font color='#0000AA'>dup</font> <font color='#008800'>"  "</font> depth<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  
  <font color='#AA0000'>(</font><font color='#0000AA'>write-buffer</font> buf
    <font color='#AA0000'>(</font><font color='#0000AA'>cond</font>
      <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>match</font> '<font color='#AA0000'>(</font>? ?<font color='#AA0000'>)</font> xml<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>empty-tag xml<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
      <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>match</font> '<font color='#AA0000'>(</font>? ? ?<font color='#AA0000'>)</font> xml<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>serialize-text-node xml<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
      <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>match</font> '<font color='#AA0000'>(</font>? ? <font color='#0000AA'>*</font><font color='#AA0000'>)</font> xml<font color='#AA0000'>)</font>
        <font color='#AA0000'>(</font><font color='#0000AA'>string</font>
          <font color='#AA0000'>(</font>opening-tag xml<font color='#AA0000'>)</font>
          <font color='#AA0000'>(</font><font color='#0000AA'>join</font> <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#AA0000'>(</font>fn <font color='#AA0000'>(</font>child<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>serialize child indent? <font color='#0000AA'>nil</font> <font color='#AA0000'>(</font><font color='#0000AA'>+</font> <font color='#665500'>1</font> depth<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>rest</font> <font color='#AA0000'>(</font><font color='#0000AA'>rest</font> xml<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
          <font color='#AA0000'>(</font><font color='#0000AA'>if</font> indent? <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#008800'>"&#092;n"</font> <font color='#AA0000'>(</font><font color='#0000AA'>dup</font> <font color='#008800'>"  "</font> depth<font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#008800'>""</font><font color='#AA0000'>)</font>
          <font color='#AA0000'>(</font>closing-tag xml<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  
  buf<font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (XML:lisp->xml &lt;sxml-list&gt; [&lt;indent?> [&lt;str-encoding&gt;]])</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;sxml-list&gt; an SXML list</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;indent?> optional; whether or not to format the resulting XML (default nil)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-encoding&gt; optional; sets the encoding in the declaration</font>
<font color='#555555'>;; &lt;p&gt;Serializes an SXML list (equivalent to parsing an XML document with</font>
<font color='#555555'>;; (xml-type-tags nil nil nil nil) and options 1 and 16). The encoding in the</font>
<font color='#555555'>;; declaration defaults to UTF-8 if newlisp was compiled with UTF-8 support,</font>
<font color='#555555'>;; ASCII otherwise.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setf</font> lisp->xml serialize<font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (XML:xml->lisp &lt;str-xml&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-xml&gt; an XML string</font>
<font color='#555555'>;; &lt;p&gt;Parses &lt;str-xml&gt; and returns an SXML list. Uses newlisp's built-in parser.&lt;/p&gt;</font>
<font color='#555555'>;; &lt;p&gt;Equivalent to:&lt;/p&gt;</font>
<font color='#555555'>;; &lt;pre&gt;(begin (xml-type-tags nil nil nil) (xml-parse &lt;str-xml&gt; (+ 1 16)))&lt;/pre&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setf</font> xml->lisp parse-string<font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> 'MAIN<font color='#AA0000'>)</font>


</pre><center><font face='Arial' size='-3' color='#666666'>syntax highlighting with <a href="http://newlisp.org">newLISP</a>&nbsp;and <a href="http://newlisp.org/newLISPdoc.html">newLISPdoc</a></font></center></body></html>
<!DOCTYPE HTML PUBLIC "4.01 Transitional"><html><title>Request</title><body><pre>
<font color='#555555'>;; <font color='#308080'>@module</font> Request</font>
<font color='#555555'>;; <font color='#308080'>@author</font> Jeff Ober &lt;jeffober@gmail.com&gt;</font>
<font color='#555555'>;; <font color='#308080'>@version</font> 1.1</font>
<font color='#555555'>;; <font color='#308080'>@location</font> http://static.artfulcode.net/newlisp/request.lsp</font>
<font color='#555555'>;; <font color='#308080'>@package</font> http://static.artfulcode.net/newlisp/request.qwerty</font>
<font color='#555555'>;; <font color='#308080'>@description</font> Request module to replace input functions in the standard CGI module (updated for newlisp 10)</font>
<font color='#555555'>;; 'Request' encapsulates the processing of CGI environmental variables in</font>
<font color='#555555'>;; a different manner than the standard CGI library.  POST and GET variables</font>
<font color='#555555'>;; are separated, and the url is parsed into a list of segments in order to</font>
<font color='#555555'>;; make use with .htaccess files and mod_rewrite simpler.</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; POST data can only be read once, after which it becomes unavailable</font>
<font color='#555555'>;; to future parts of the program.  Should the default cgi.lsp module precede</font>
<font color='#555555'>;; this module, POST data will be unavailable through the Request class.  If</font>
<font color='#555555'>;; cgi.lsp is loaded after this module, POST data is unavailable to it.</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; This module does not include output functions, including setting cookies.</font>
<font color='#555555'>;; Output is a function of the Response class.</font>
<font color='#555555'>;; &lt;h4&gt;Version history&lt;/h4&gt;</font>
<font color='#555555'>;; &lt;b&gt;1.1&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; fixed incompatibilites with newlisp 10</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;1.0&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; initial release</font>

<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> '*max-post-length* <font color='#665500'>4096</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>global</font> '*max-post-length*<font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> 'Request<font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> _cgi-keys '<font color='#AA0000'>(</font><font color='#008800'>"REDIRECT_STATUS"</font> <font color='#008800'>"HTTP_HOST"</font> <font color='#008800'>"HTTP_USER_AGENT"</font> <font color='#008800'>"HTTP_ACCEPT"</font>
  <font color='#008800'>"HTTP_ACCEPT_LANGUAGE"</font> <font color='#008800'>"HTTP_ACCEPT_ENCODING"</font> <font color='#008800'>"HTTP_ACCEPT_CHARSET"</font>
  <font color='#008800'>"HTTP_KEEP_ALIVE"</font> <font color='#008800'>"HTTP_CONNECTION"</font> <font color='#008800'>"HTTP_COOKIE"</font> <font color='#008800'>"HTTP_CACHE_CONTROL"</font> <font color='#008800'>"PATH"</font>
  <font color='#008800'>"SERVER_SIGNATURE"</font> <font color='#008800'>"SERVER_SOFTWARE"</font> <font color='#008800'>"SERVER_NAME"</font> <font color='#008800'>"SERVER_ADDR"</font> <font color='#008800'>"SERVER_PORT"</font>
  <font color='#008800'>"REMOTE_ADDR"</font> <font color='#008800'>"DOCUMENT_ROOT"</font> <font color='#008800'>"SERVER_ADMIN"</font> <font color='#008800'>"SCRIPT_FILENAME"</font> <font color='#008800'>"REMOTE_PORT"</font>
  <font color='#008800'>"REDIRECT_URL"</font> <font color='#008800'>"GATEWAY_INTERFACE"</font> <font color='#008800'>"SERVER_PROTOCOL"</font> <font color='#008800'>"REQUEST_METHOD"</font>
  <font color='#008800'>"QUERY_STRING"</font> <font color='#008800'>"REQUEST_URI"</font> <font color='#008800'>"SCRIPT_NAME"</font> <font color='#008800'>"PATH_INFO"</font> <font color='#008800'>"PATH_TRANSLATED"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;; set cleaned CGI environment parameters</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> _cgi-env <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#AA0000'>(</font>fn <font color='#AA0000'>(</font>key<font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>list</font> key <font color='#AA0000'>(</font><font color='#0000AA'>trim</font> <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#AA0000'>(</font><font color='#0000AA'>env</font> key<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> _cgi-keys<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;; set default method</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> _method <font color='#008800'>"get"</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>parse-query query-string<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>let</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>params '<font color='#AA0000'>(</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>dolist</font> <font color='#AA0000'>(</font>element <font color='#AA0000'>(</font><font color='#0000AA'>parse</font> query-string <font color='#008800'>"&amp;"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>let</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>pair <font color='#AA0000'>(</font><font color='#0000AA'>parse</font> element <font color='#008800'>"="</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
        <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>=</font> <font color='#665500'>1</font> <font color='#AA0000'>(</font><font color='#0000AA'>length</font> pair<font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>push</font> <font color='#0000AA'>nil</font> pair <font color='#665500'>-1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
        <font color='#AA0000'>(</font><font color='#0000AA'>push</font> pair params <font color='#665500'>-1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    params<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;; deal with GET params from QUERY_STRING</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> _get <font color='#AA0000'>(</font>parse-query <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> <font color='#008800'>"QUERY_STRING"</font> _cgi-env<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;; deal with POST params from stdin data</font>
<font color='#AA0000'>(</font><font color='#0000AA'>read-buffer</font> <font color='#AA0000'>(</font><font color='#0000AA'>device</font><font color='#AA0000'>)</font> post-data *max-post-length*<font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> _post '<font color='#AA0000'>(</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>when</font> post-data
  <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> _method <font color='#008800'>"post"</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> _post <font color='#AA0000'>(</font>parse-query post-data<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;; deal with HTTP_COOKIE data</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> _cookies '<font color='#AA0000'>(</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>dolist</font> <font color='#AA0000'>(</font>element <font color='#AA0000'>(</font><font color='#0000AA'>parse</font> <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> <font color='#008800'>"HTTP_COOKIE"</font> _cgi-env<font color='#AA0000'>)</font> <font color='#008800'>"&#059;"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>let</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>pair <font color='#AA0000'>(</font><font color='#0000AA'>parse</font> element <font color='#008800'>"="</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>push</font> pair _cookies <font color='#665500'>-1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;; store segment information</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> _segments <font color='#AA0000'>(</font><font color='#0000AA'>parse</font> <font color='#AA0000'>(</font><font color='#0000AA'>trim</font> <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> <font color='#008800'>"REQUEST_URI"</font> _cgi-env<font color='#AA0000'>)</font> <font color='#008800'>"/"</font><font color='#AA0000'>)</font> <font color='#008800'>"/"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (Request:method)</font>
<font color='#555555'>;; <font color='#308080'>@return</font> string</font>
<font color='#555555'>;; &lt;p&gt;Returns the request method.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>method<font color='#AA0000'>)</font>
  _method<font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (Request:get?)</font>
<font color='#555555'>;; <font color='#308080'>@return</font> boolean</font>
<font color='#555555'>;; &lt;p&gt;Predicates that the request method is GET.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>get?<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>=</font> _method <font color='#008800'>"get"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (Request:post?)</font>
<font color='#555555'>;; <font color='#308080'>@return</font> boolean</font>
<font color='#555555'>;; &lt;p&gt;Predicates that the request method is POST.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>post?<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>=</font> _method <font color='#008800'>"post"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (Request:get &lt;str-key&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-key&gt; a GET variable</font>
<font color='#555555'>;; &lt;p&gt;Fetches a GET variable from the query string.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>get key<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> key
    <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> key _get<font color='#AA0000'>)</font>
    _get<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (Request:post &lt;str-key&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-key&gt; a POST variable</font>
<font color='#555555'>;; &lt;p&gt;Fetches a POST variable from the request content.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>post key<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> key
    <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> key _post<font color='#AA0000'>)</font>
    _post<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (Request:cookies &lt;str-key&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-key&gt; a COOKIE variable</font>
<font color='#555555'>;; &lt;p&gt;Fetches the value of a cookie.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>cookies key<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> key
    <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> key _cookies<font color='#AA0000'>)</font>
    _cookies<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (Request:cookie? &lt;str-key&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-key&gt; a COOKIE variable</font>
<font color='#555555'>;; &lt;p&gt;Predicates that a COOKIE variable is set.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>cookie? key<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> key _cookies<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> _current-segment <font color='#665500'>-1</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>segment<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>unless</font> <font color='#AA0000'>(</font><font color='#0000AA'>>=</font> _current-segment <font color='#AA0000'>(</font><font color='#0000AA'>-</font> <font color='#AA0000'>(</font><font color='#0000AA'>length</font> _segments<font color='#AA0000'>)</font> <font color='#665500'>1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>nth</font> <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>args</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>args</font> <font color='#665500'>0</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>inc</font> '_current-segment<font color='#AA0000'>)</font><font color='#AA0000'>)</font> _segments<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (Request:segments)</font>
<font color='#555555'>;; <font color='#308080'>@return</font> list</font>
<font color='#555555'>;; &lt;p&gt;Returns a list of each part of the query path, e.g.</font>
<font color='#555555'>;; /foo/bar/baz becomes '("foo" "bar" "baz")'.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>segments<font color='#AA0000'>)</font>
  _segments<font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> path <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> <font color='#008800'>"REQUEST_URI"</font> _cgi-env<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> domain <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> <font color='#008800'>"HTTP_HOST"</font> _cgi-env<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> MAIN<font color='#AA0000'>)</font>



</pre><center><font face='Arial' size='-3' color='#666666'>syntax highlighting with <a href="http://newlisp.org">newLISP</a>&nbsp;and <a href="http://newlisp.org/newLISPdoc.html">newLISPdoc</a></font></center></body></html>
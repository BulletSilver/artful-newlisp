<!DOCTYPE HTML PUBLIC "4.01 Transitional"><html><title>Mysql</title><body><pre>
<font color='#555555'>;; <font color='#308080'>@module</font> Mysql</font>
<font color='#555555'>;; <font color='#308080'>@author</font> Jeff Ober &lt;jeffober@gmail.com&gt;</font>
<font color='#555555'>;; <font color='#308080'>@version</font> 1.05 beta</font>
<font color='#555555'>;; <font color='#308080'>@location</font> http://static.artfulcode.net/newlisp/mysql.lsp</font>
<font color='#555555'>;; <font color='#308080'>@package</font> http://static.artfulcode.net/newlisp/mysql.qwerty</font>
<font color='#555555'>;; <font color='#308080'>@description</font> A new MySQL module to replace the distribution standard module (requires newlisp 10).</font>
<font color='#555555'>;; The Mysql module has been written from scratch utilizing some of the more</font>
<font color='#555555'>;; recent features of newLisp, such as FOOP and reference returns. One of its</font>
<font color='#555555'>;; major design goals was to simplify use as well as broaden the features of</font>
<font color='#555555'>;; the standard MySQL module, while at the same time allowing the creation of</font>
<font color='#555555'>;; new, anonymous instances at run-time.</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; The Mysql module differs from the distribution standard module in several</font>
<font color='#555555'>;; important ways. Most obviously, it uses FOOP wrappers for MySQL types. It</font>
<font color='#555555'>;; also requires clients to free results instances; in the standard module,</font>
<font color='#555555'>;; only the base MYSQL instance itself must be freed (using MySQL:close-db).</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; The significance of this is that it is much simpler to create multiple</font>
<font color='#555555'>;; connections (without having to duplicate the entire context at compile</font>
<font color='#555555'>;; time). Result sets are completely independent of each other, and several may</font>
<font color='#555555'>;; be maintained in any state at once. This also means that a spawned process</font>
<font color='#555555'>;; may be given its own Mysql instance to use without having to worry about</font>
<font color='#555555'>;; other processes' instances interfering. Using the standard module, the</font>
<font color='#555555'>;; entire context would need to be cloned at compile time and given a static</font>
<font color='#555555'>;; symbol reference (e.g., (new 'MySQL 'db)) in order to run multiple instances</font>
<font color='#555555'>;; or connections to a server.</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; Moreover, because this module uses unpack and MySQL C API accessor</font>
<font color='#555555'>;; functions, there is no need for the client to calculate member offsets in</font>
<font color='#555555'>;; MySQL compound types. So long as newLisp was compiled for the same target as</font>
<font color='#555555'>;; the libmysqlclient library (both are 32 bit or both are 64 bit), everything</font>
<font color='#555555'>;; should work out of the box. Additionally, MySQL errors are now checked in</font>
<font color='#555555'>;; the connect and query functions and re-thrown as interpreter errors. Instead</font>
<font color='#555555'>;; of checking for nil returns and a using MySQL:error to get the error</font>
<font color='#555555'>;; message, standard error  handling with the catch function may be used.</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; This module has been tested with MySQL version 5 and 5.1 and newLisp version</font>
<font color='#555555'>;; 10.0.1. It requires newLisp 10.0 or later.</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;h3&gt;Changelog&lt;/h3&gt;</font>
<font color='#555555'>;; &lt;b&gt;1.05&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; Mysql:query now checks if client mistakenly sent single, non-list, argument for format-args</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;1.04&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; fixed error in documentation example</font>
<font color='#555555'>;; &amp;bull; changed Mysql:query to allow lists as format parameters</font>
<font color='#555555'>;; &amp;bull; backward-incompatible change to Mysql:query parameter list</font>
<font color='#555555'>;; &amp;bull; added Mysql:coerce-type as an independent function</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;1.03&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; fixed truncation bug when inserting binary data in Mysql:query</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;1.02&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; field types are now correctly distinguished when MySQL is compiled with 64-bit pointers</font>
<font color='#555555'>;; &amp;bull; refactored MysqlResult:get-row</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;1.01&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; fixed invalid function in Mysql:tables, Mysql:fields, and Mysql:databases</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;1.0&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; initial release</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;h3&gt;Known bugs&lt;/h3&gt;</font>
<font color='#555555'>;; &amp;bull; None (at the moment); &lt;i&gt;please let me know if you find any!&lt;/i&gt;</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; </font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; &amp;bull; Imperative usage</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; (setf db (Mysql)) ; initialize Mysql instance</font>
<font color='#555555'>;; (:connect db "localhost" "user" "secret" "my_database") ; connect to a server</font>
<font color='#555555'>;; (setf result (:query db "SELECT * FROM some_table")) ; evaluate a query</font>
<font color='#555555'>;; (setf rows (:fetch-all result)) ; generate a result</font>
<font color='#555555'>;; (:close-db db) ; free the database</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &amp;bull; Functional usage with the 'mysql context</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; (mysql:on-connect '("localhost" "user" "secret" "my_database")</font>
<font color='#555555'>;;   (lambda (db err)</font>
<font color='#555555'>;;     (if err (throw-error err))</font>
<font color='#555555'>;;     (mysql:row-iter db "SELECT * FROM some_table" nil</font>
<font color='#555555'>;;       (lambda (row)</font>
<font color='#555555'>;;         (println row)))))</font>

<font color='#555555'>;;;============================================================================</font>
<font color='#555555'>;;; MyCType: a base class providing a basic framework for working with</font>
<font color='#555555'>;;; MySQL C types and functions</font>
<font color='#555555'>;;;============================================================================</font>

<font color='#AA0000'>(</font><font color='#0000AA'>setf</font> MyCType:pack-format <font color='#0000AA'>nil</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>MyCType:MyCType addr<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>list</font> <font color='#AA0000'>(</font><font color='#0000AA'>context</font><font color='#AA0000'>)</font> addr<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>MyCType:pointer inst<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>inst <font color='#665500'>1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>MyCType:members inst<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>unpack</font> MyCType:pack-format <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>MyCType:member inst n , unpacked<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>nth</font> n <font color='#AA0000'>(</font>:members inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;;============================================================================</font>
<font color='#555555'>;;; Utility functions and macros</font>
<font color='#555555'>;;;============================================================================</font>

<font color='#AA0000'>(</font><font color='#0000AA'>unless</font> if-not-zero
  <font color='#AA0000'>(</font><font color='#0000AA'>define-macro</font> <font color='#AA0000'>(</font>if-not-zero<font color='#AA0000'>)</font>
    "If the <font color='#0000AA'>first</font> argument is <font color='#0000AA'>not</font> zero, evaluates the <font color='#0000AA'>rest</font> of the arguments.
    Useful <font color='#0000AA'>for</font> checking <font color='#0000AA'>if</font> the return argument of a C function is non-NULL."
    <font color='#AA0000'>(</font><font color='#0000AA'>letex</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>ptr <font color='#AA0000'>(</font><font color='#0000AA'>eval</font> <font color='#AA0000'>(</font><font color='#0000AA'>args</font> <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>body <font color='#AA0000'>(</font><font color='#0000AA'>cons</font> 'begin <font color='#AA0000'>(</font><font color='#0000AA'>rest</font> <font color='#AA0000'>(</font><font color='#0000AA'>args</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>if-not</font> <font color='#AA0000'>(</font><font color='#0000AA'>zero?</font> ptr<font color='#AA0000'>)</font>
        body
        <font color='#0000AA'>nil</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

  <font color='#AA0000'>(</font><font color='#0000AA'>constant</font> <font color='#AA0000'>(</font><font color='#0000AA'>global</font> 'if-not-zero<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;;============================================================================</font>
<font color='#555555'>;;; Pre-declare classes and contexts to prevent circular dependencies</font>
<font color='#555555'>;;;============================================================================</font>

<font color='#AA0000'>(</font><font color='#0000AA'>new</font> 'MyCType 'Mysql<font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>new</font> 'MyCType 'MysqlField<font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>new</font> 'MyCType 'MysqlResult<font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>sym</font> <font color='#008800'>"_mysql"</font> '_MYSQL<font color='#AA0000'>)</font>

<font color='#555555'>;;;============================================================================</font>
<font color='#555555'>;;; _MYSQL context stores API functions from libmysqlclient</font>
<font color='#555555'>;;;============================================================================</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> '_MYSQL<font color='#AA0000'>)</font>

<font color='#555555'>;;; Find the libmysqlclient library on this system</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setf</font> is-64-bit <font color='#0000AA'>nil</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>let</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>paths '<font color='#AA0000'>(</font><font color='#008800'>"/usr/lib/libmysqlclient.so"</font>
               <font color='#008800'>"/usr/lib64/mysql/libmysqlclient.so"</font>
               <font color='#008800'>"/usr/local/mysql/lib/libmysqlclient.dylib"</font>
               <font color='#008800'>"/opt/local/lib/libmysqlclient.dylib"</font>
               <font color='#008800'>"/sw/lib/libmysqlclient.dylib"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'libmysqlclient
    <font color='#AA0000'>(</font><font color='#0000AA'>catch</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>dolist</font> <font color='#AA0000'>(</font>path paths<font color='#AA0000'>)</font>
        <font color='#AA0000'>(</font><font color='#0000AA'>when</font> <font color='#AA0000'>(</font><font color='#0000AA'>file?</font> path<font color='#AA0000'>)</font>
          <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>find</font> <font color='#008800'>"lib64"</font> path<font color='#AA0000'>)</font> <font color='#555555'>; some pack formats depend on this</font>
            <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> is-64-bit <font color='#0000AA'>true</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
          <font color='#AA0000'>(</font><font color='#0000AA'>throw</font> path<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;; Import library functions</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmysqlclient <font color='#008800'>"mysql_affected_rows"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmysqlclient <font color='#008800'>"mysql_close"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmysqlclient <font color='#008800'>"mysql_error"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmysqlclient <font color='#008800'>"mysql_free_result"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmysqlclient <font color='#008800'>"mysql_init"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmysqlclient <font color='#008800'>"mysql_insert_id"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmysqlclient <font color='#008800'>"mysql_real_connect"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmysqlclient <font color='#008800'>"mysql_real_query"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmysqlclient <font color='#008800'>"mysql_store_result"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmysqlclient <font color='#008800'>"mysql_num_fields"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmysqlclient <font color='#008800'>"mysql_fetch_field"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmysqlclient <font color='#008800'>"mysql_num_rows"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmysqlclient <font color='#008800'>"mysql_fetch_row"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmysqlclient <font color='#008800'>"mysql_fetch_lengths"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmysqlclient <font color='#008800'>"mysql_fetch_field_direct"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> libmysqlclient <font color='#008800'>"mysql_real_escape_string"</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> 'MAIN<font color='#AA0000'>)</font>

<font color='#555555'>;;;============================================================================</font>
<font color='#555555'>;;; Mysql: An independent MySQL connection</font>
<font color='#555555'>;;;============================================================================</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (Mysql)</font>
<font color='#555555'>;; &lt;p&gt;Returns a new Mysql instance that can safely be used in tandem with other</font>
<font color='#555555'>;; Mysql instances.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>Mysql:Mysql , ptr<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> ptr <font color='#AA0000'>(</font>_MYSQL:mysql_init <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>if-not-zero ptr
    <font color='#AA0000'>(</font><font color='#0000AA'>list</font> Mysql ptr<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:connect &lt;Mysql-instance&gt; &lt;str-host&gt; &lt;str-user&gt; &lt;str-pass&gt; &lt;str-db&gt; &lt;int-port&gt; &lt;str-socket&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;Mysql-instance&gt; an instance of the Mysql class</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-host&gt; the hostname to connect to</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-user&gt; a MySQL username</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-pass&gt; &lt;str-user&gt;'s password</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-db&gt; the database to initially connect to</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;int-port&gt; (optional) port number of the MySQL server</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;int-str&gt; (optional) socket file to connect through</font>
<font color='#555555'>;; &lt;p&gt;Connects an initialized Mysql instance to a database. Returns &lt;true&gt; if</font>
<font color='#555555'>;; successful logging in, &lt;nil&gt; if not.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (setf db (Mysql))</font>
<font color='#555555'>;; (:connect db "localhost" "user" "secret" "my-database")</font>
<font color='#555555'>;; => true</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>Mysql:connect inst host user pass db <font color='#AA0000'>(</font>port <font color='#665500'>0</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>socket <font color='#665500'>0</font><font color='#AA0000'>)</font> , result<font color='#AA0000'>)</font>
  <font color='#008800'>"Connects to a MySQL database. Throws an error on failure."</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> result <font color='#AA0000'>(</font>_MYSQL:mysql_real_connect <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font> host user pass db port socket <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>zero?</font> result<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>throw-error</font> <font color='#AA0000'>(</font>:error inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#0000AA'>true</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:close &lt;Mysql-instance&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;Mysql-instance&gt; an instance of the Mysql class</font>
<font color='#555555'>;; &lt;p&gt;Closes the connection and frees any memory used. This does &lt;not&gt; free the memory</font>
<font color='#555555'>;; used by results sets from this connection.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>Mysql:close-db inst<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>_MYSQL:mysql_close <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:error &lt;Mysql-instance&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;Mysql-instance&gt; an instance of the Mysql class</font>
<font color='#555555'>;; &lt;p&gt;Returns the last error message as a string or &lt;nil&gt; if there is none.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>Mysql:error inst , ptr str<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> ptr <font color='#AA0000'>(</font>_MYSQL:mysql_error <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#555555'>; mysql_error always returns a valid string. If there is no error,</font>
  <font color='#555555'>; the string will be empty.</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> str <font color='#AA0000'>(</font><font color='#0000AA'>get-string</font> ptr<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>=</font> <font color='#008800'>""</font> str<font color='#AA0000'>)</font> <font color='#0000AA'>nil</font> str<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:coerce-type &lt;Mysql-instance&gt; &lt;object&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;Mysql-instance&gt; an instance of the Mysql class</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;object&gt; a newLisp object</font>
<font color='#555555'>;; &lt;p&gt;Coerces &lt;object&gt; into something safe to use in a SQL statement. Lists are</font>
<font color='#555555'>;; converted into MySQL lists (e.g. '("foo" "bar" "baz") to</font>
<font color='#555555'>;; ('foo', 'bar', 'baz')) and string values are escaped. This is a helper</font>
<font color='#555555'>;; function for &lt;Mysql:query&gt;.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>Mysql:coerce-type inst value<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>cond</font>
    <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>nil?</font> value<font color='#AA0000'>)</font> <font color='#008800'>"NULL"</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>or</font> <font color='#AA0000'>(</font><font color='#0000AA'>=</font> value <font color='#008800'>"null"</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>=</font> value <font color='#008800'>"NULL"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> value<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>number?</font> value<font color='#AA0000'>)</font> value<font color='#AA0000'>)</font>
    <font color='#555555'>; Here the string must be packed to be sure that it is not truncated.</font>
    <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>string?</font> value<font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>format</font> <font color='#008800'>"'%s'"</font> <font color='#AA0000'>(</font>:escape inst <font color='#AA0000'>(</font><font color='#0000AA'>pack</font> <font color='#AA0000'>(</font><font color='#0000AA'>format</font> <font color='#008800'>"s%d"</font> <font color='#AA0000'>(</font><font color='#0000AA'>length</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>list?</font> value<font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#008800'>"("</font> <font color='#AA0000'>(</font><font color='#0000AA'>join</font> <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>string</font> <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#AA0000'>(</font><font color='#0000AA'>curry</font> Mysql:coerce-type inst<font color='#AA0000'>)</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#008800'>", "</font><font color='#AA0000'>)</font> <font color='#008800'>")"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>true</font> <font color='#AA0000'>(</font><font color='#0000AA'>format</font> <font color='#008800'>"'%s'"</font> <font color='#AA0000'>(</font>:escape inst <font color='#AA0000'>(</font><font color='#0000AA'>string</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:query &lt;Mysql-instance&gt; &lt;str-statement&gt; [&lt;lst-format-args&gt;])</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;Mysql-instance&gt; an instance of the Mysql class</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-statement&gt; a SQL statement to execute</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;lst-format-args&gt; format arguments to the SQL statement</font>
<font color='#555555'>;; &lt;p&gt;Executes &lt;str-statement&gt;. Throws an error if the statement fails with the</font>
<font color='#555555'>;; reason. If the statement returns results, a &lt;MysqlResult&gt; class instance is</font>
<font color='#555555'>;; returned. Otherwise, returns the number of affected rows.&lt;/p&gt;</font>
<font color='#555555'>;; &lt;p&gt;If &lt;lst-format-args&gt; is specified, all parameters are escaped (as</font>
<font color='#555555'>;; necessary) to generate safe, valid SQL. No quoting of values is required in</font>
<font color='#555555'>;; the format string; quotes are inserted as needed. To generate a</font>
<font color='#555555'>;; NULL in the SQL statement, pass &lt;nil&gt; or the string "NULL".&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (:query db "SELECT name, employee_id FROM employees")</font>
<font color='#555555'>;; => (MysqlResult 1069216)</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; (:query db "DELETE FROM employees WHERE fired = 1")</font>
<font color='#555555'>;; => 14</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; (:query db '("SELECT id FROM employees WHERE name = %s" '("Johnson, John")))</font>
<font color='#555555'>;; ; SQL generated: SELECT id FROM employees WHERE name = 'Johnson, John'</font>
<font color='#555555'>;; => (MysqlResult 1069216)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>Mysql:query inst sql format-args , res ptr err params<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>unless</font> <font color='#AA0000'>(</font><font color='#0000AA'>or</font> <font color='#AA0000'>(</font><font color='#0000AA'>null?</font> format-args<font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>list?</font> format-args<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>throw-error</font> <font color='#008800'>"Format args must be passed to Mysql:query as a list!"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  
  <font color='#AA0000'>(</font><font color='#0000AA'>when</font> <font color='#AA0000'>(</font><font color='#0000AA'>list?</font> format-args<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> format-args <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#AA0000'>(</font>fn <font color='#AA0000'>(</font>v<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>:coerce-type inst v<font color='#AA0000'>)</font><font color='#AA0000'>)</font> format-args<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> sql <font color='#AA0000'>(</font><font color='#0000AA'>format</font> sql format-args<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> res <font color='#AA0000'>(</font>_MYSQL:mysql_real_query <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font> sql <font color='#AA0000'>(</font><font color='#0000AA'>+</font> <font color='#665500'>1</font> <font color='#AA0000'>(</font><font color='#0000AA'>length</font> sql<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>zero?</font> res<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>begin</font>
      <font color='#555555'>; Always attempt to store result firt. This does not degrade performance</font>
      <font color='#555555'>; for non-result-returning queries (according to the MySQL C API docs).</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> ptr <font color='#AA0000'>(</font>_MYSQL:mysql_store_result <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
      <font color='#555555'>; If mysql_store_result returns a null pointer, it may be an error or</font>
      <font color='#555555'>; just mean that a query has no results (e.g. INSERT, DELETE, UPDATE).</font>
      <font color='#555555'>; Error status requires a combination of a null pointer and a result</font>
      <font color='#555555'>; from error.</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>when</font> <font color='#AA0000'>(</font><font color='#0000AA'>and</font> <font color='#AA0000'>(</font><font color='#0000AA'>zero?</font> ptr<font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> err <font color='#AA0000'>(</font>:error inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
        <font color='#AA0000'>(</font><font color='#0000AA'>throw-error</font> err<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
      <font color='#555555'>; Otherwise, return an appropriate value. In the case of a non-result-</font>
      <font color='#555555'>; returning query, return the number of affected rows. Otherwise, return</font>
      <font color='#555555'>; a MysqlResult instance.</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>zero?</font> ptr<font color='#AA0000'>)</font>
        <font color='#AA0000'>(</font>:affected-rows inst<font color='#AA0000'>)</font>
        <font color='#AA0000'>(</font>MysqlResult ptr<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#555555'>; mysql_real_query returns non-zero in case of an error.</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>throw-error</font> <font color='#AA0000'>(</font>:error inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:insert-id &lt;Mysql-instance&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;Mysql-instance&gt; an instance of the Mysql class</font>
<font color='#555555'>;; &lt;p&gt;Returns the id of the last inserted row when the target table contains</font>
<font color='#555555'>;; an AUTOINCREMENT field.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>Mysql:insert-id inst<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>_MYSQL:mysql_insert_id <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:affected-rows &lt;Mysql-instance&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;Mysql-instance&gt; an instance of the Mysql class</font>
<font color='#555555'>;; &lt;p&gt;Returns the number of rows affected by the most recent query.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>Mysql:affected-rows inst<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>_MYSQL:mysql_affected_rows <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:escape &lt;Mysql-instance&gt; &lt;str-value&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;Mysql-instance&gt; an instance of the Mysql class</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-value&gt; the string to escape</font>
<font color='#555555'>;; &lt;p&gt;Escapes a string to assure safety for use in a SQL statement.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>Mysql:escape inst str , res<font color='#AA0000'>)</font> 
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> res <font color='#AA0000'>(</font><font color='#0000AA'>dup</font> <font color='#008800'>" "</font> <font color='#AA0000'>(</font><font color='#0000AA'>+</font> <font color='#665500'>1</font> <font color='#AA0000'>(</font><font color='#0000AA'>*</font> <font color='#665500'>2</font> <font color='#AA0000'>(</font><font color='#0000AA'>length</font> str<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> 
  <font color='#AA0000'>(</font>_MYSQL:mysql_real_escape_string <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font> res str <font color='#AA0000'>(</font><font color='#0000AA'>length</font> str<font color='#AA0000'>)</font><font color='#AA0000'>)</font> 
  res<font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:databases &lt;Mysql-instance&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;Mysql-instance&gt; an instance of the Mysql class</font>
<font color='#555555'>;; &lt;p&gt;Returns a list of the databases on this server.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>Mysql:databases inst , res<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> res <font color='#AA0000'>(</font>:query inst <font color='#008800'>"SHOW DATABASES"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>first</font> <font color='#AA0000'>(</font>:fetch-rows res <font color='#0000AA'>nil</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:tables &lt;Mysql-instance&gt; &lt;str-database&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;Mysql-instance&gt; an instance of the Mysql class</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-database&gt; (optional) the database to query for tables</font>
<font color='#555555'>;; &lt;p&gt;Returns a list of tables available on this server. If &lt;str-database&gt; is</font>
<font color='#555555'>;; provided, the list of tables will be limited to that database.</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>Mysql:tables inst db , sql res<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> sql <font color='#AA0000'>(</font><font color='#0000AA'>if</font> db <font color='#AA0000'>(</font><font color='#0000AA'>format</font> <font color='#008800'>"SHOW TABLES FROM `%s`"</font> db<font color='#AA0000'>)</font> <font color='#008800'>"SHOW TABLES"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> res <font color='#AA0000'>(</font>:query inst sql<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>first</font> <font color='#AA0000'>(</font>:fetch-all res <font color='#0000AA'>nil</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:fields &lt;Mysql-instance&gt; &lt;str-table&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;Mysql-instance&gt; an instance of the Mysql class</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-table&gt; the table to display</font>
<font color='#555555'>;; &lt;p&gt;Returns metadata about the fields in &lt;str-table&gt;. The data is the result</font>
<font color='#555555'>;; of a 'SHOW FIELDS' query.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>Mysql:fields inst table<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> res <font color='#AA0000'>(</font>:query inst <font color='#AA0000'>(</font><font color='#0000AA'>format</font> <font color='#008800'>"SHOW FIELDS FROM `%s`"</font> table<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>:fetch-rows res<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;;============================================================================</font>
<font color='#555555'>;;; MysqlResult: The result of a MySQL query</font>
<font color='#555555'>;;;============================================================================</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (MysqlResult &lt;int-pointer&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;int-pointer&gt; a pointer to a MYSQL_RES struct</font>
<font color='#555555'>;; &lt;p&gt;Objects of this class are returned by Mysql:query as a result of queries</font>
<font color='#555555'>;; that generate result sets. This class is not generally instantiated directly</font>
<font color='#555555'>;; by the client.&lt;/p&gt;</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:free &lt;MysqlResult-instance&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;MysqlResult-instance&gt; an instance of the MysqlResult class</font>
<font color='#555555'>;; &lt;p&gt;Frees the memory used by a result. Must be called for each &lt;MysqlResult&gt;</font>
<font color='#555555'>;; generated, even if unused.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>MysqlResult:free inst<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>_MYSQL:mysql_free_result <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:num-rows &lt;MysqlResult-instance&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;MysqlResult-instance&gt; an instance of the MysqlResult class</font>
<font color='#555555'>;; &lt;p&gt;Returns the number of results in this result.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>MysqlResult:num-rows inst<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>_MYSQL:mysql_num_rows <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>MysqlResult:num-fields inst<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>_MYSQL:mysql_num_fields <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>MysqlResult:column-lengths inst<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>_MYSQL:mysql_fetch_lengths <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:fields &lt;MysqlResult-instance&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;MysqlResult-instance&gt; an instance of the MysqlResult class</font>
<font color='#555555'>;; &lt;p&gt;Returns a list of MysqlField instances corresponding to the columns in</font>
<font color='#555555'>;; this result.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>MysqlResult:fields inst , n ptr fields<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> fields '<font color='#AA0000'>(</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> n <font color='#AA0000'>(</font>_MYSQL:mysql_num_fields <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>until</font> <font color='#AA0000'>(</font><font color='#0000AA'>zero?</font> <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> ptr <font color='#AA0000'>(</font>_MYSQL:mysql_fetch_field <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>push</font> <font color='#AA0000'>(</font>MysqlField ptr<font color='#AA0000'>)</font> fields <font color='#665500'>-1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  fields<font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:fetch-row &lt;MysqlResult-instance&gt; &lt;as-assoc&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;MysqlResult-instance&gt; an instance of the MysqlResult class</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;as-assoc&gt; (optional) whether to return results as a list or association list</font>
<font color='#555555'>;; &lt;p&gt;Returns one row from this result. If &lt;as-assoc&gt; is true, the results will</font>
<font color='#555555'>;; be returned as an association list (true by default). If this is the final row</font>
<font color='#555555'>;; in the result set, the MysqlResult instance is automatically freed.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>MysqlResult:fetch-row inst <font color='#AA0000'>(</font>as-assoc <font color='#0000AA'>true</font><font color='#AA0000'>)</font> , ptr num-fields cols lengths row<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> ptr <font color='#AA0000'>(</font>_MYSQL:mysql_fetch_row <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>if-not-zero ptr
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> num-fields <font color='#AA0000'>(</font>:num-fields inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> cols <font color='#AA0000'>(</font><font color='#0000AA'>unpack</font> <font color='#AA0000'>(</font><font color='#0000AA'>dup</font> <font color='#008800'>"lu"</font> num-fields<font color='#AA0000'>)</font> ptr<font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#555555'>; pointers to each column's start</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> lengths <font color='#AA0000'>(</font><font color='#0000AA'>unpack</font> <font color='#AA0000'>(</font><font color='#0000AA'>dup</font> <font color='#008800'>"lu"</font> num-fields<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>:column-lengths inst<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#555555'>; the length of each column</font>
    <font color='#555555'>; We must use the lengths because binary fields might contain null characters,</font>
    <font color='#555555'>; which will fool get-string, which grabs chars until it hits a null.</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> row
      <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#AA0000'>(</font>lambda <font color='#AA0000'>(</font>len col i , value field result<font color='#AA0000'>)</font>
             <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> field <font color='#AA0000'>(</font>MysqlField <font color='#AA0000'>(</font>_MYSQL:mysql_fetch_field_direct <font color='#AA0000'>(</font>:pointer inst<font color='#AA0000'>)</font> i<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
             <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> value <font color='#AA0000'>(</font><font color='#0000AA'>first</font> <font color='#AA0000'>(</font><font color='#0000AA'>unpack</font> <font color='#AA0000'>(</font><font color='#0000AA'>format</font> <font color='#008800'>"s%d"</font> len<font color='#AA0000'>)</font> col<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
             <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> value
               <font color='#AA0000'>(</font><font color='#0000AA'>case</font> <font color='#AA0000'>(</font>:type field<font color='#AA0000'>)</font>
         				 <font color='#AA0000'>(</font><font color='#008800'>"bigint"</font> <font color='#AA0000'>(</font><font color='#0000AA'>int</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
         				 <font color='#AA0000'>(</font><font color='#008800'>"bit"</font> <font color='#AA0000'>(</font><font color='#0000AA'>int</font> value <font color='#665500'>2</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#555555'>; untested</font>
         				 <font color='#AA0000'>(</font><font color='#008800'>"date "</font> <font color='#AA0000'>(</font><font color='#0000AA'>apply</font> <font color='#0000AA'>date-value</font> <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>int</font> <font color='#AA0000'>(</font><font color='#0000AA'>parse</font> value <font color='#008800'>"-"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
         				 <font color='#AA0000'>(</font><font color='#008800'>"datetime"</font> <font color='#AA0000'>(</font><font color='#0000AA'>apply</font> <font color='#0000AA'>date-value</font> <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>int</font> <font color='#AA0000'>(</font><font color='#0000AA'>parse</font> value <font color='#008800'>"[-: ]"</font> <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
         				 <font color='#AA0000'>(</font><font color='#008800'>"decimal"</font> <font color='#AA0000'>(</font><font color='#0000AA'>float</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
         				 <font color='#AA0000'>(</font><font color='#008800'>"double"</font> <font color='#AA0000'>(</font><font color='#0000AA'>float</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
         				 <font color='#AA0000'>(</font><font color='#008800'>"float"</font> <font color='#AA0000'>(</font><font color='#0000AA'>float</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
         				 <font color='#AA0000'>(</font><font color='#008800'>"integer"</font> <font color='#AA0000'>(</font><font color='#0000AA'>int</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
         				 <font color='#AA0000'>(</font><font color='#008800'>"mediumint"</font> <font color='#AA0000'>(</font><font color='#0000AA'>int</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
         				 <font color='#AA0000'>(</font><font color='#008800'>"null"</font> <font color='#0000AA'>nil</font><font color='#AA0000'>)</font>
         				 <font color='#AA0000'>(</font><font color='#008800'>"smallint"</font> <font color='#AA0000'>(</font><font color='#0000AA'>int</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
         				 <font color='#AA0000'>(</font><font color='#008800'>"time"</font> <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>int</font> <font color='#AA0000'>(</font><font color='#0000AA'>parse</font> value <font color='#008800'>":"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#555555'>; does not map to newlisp data type</font>
         				 <font color='#AA0000'>(</font><font color='#008800'>"timestamp"</font> <font color='#AA0000'>(</font><font color='#0000AA'>apply</font> <font color='#0000AA'>date-value</font> <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>int</font> <font color='#AA0000'>(</font><font color='#0000AA'>parse</font> value <font color='#008800'>"[-: ]"</font> <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
         				 <font color='#AA0000'>(</font><font color='#008800'>"tinyint"</font> <font color='#AA0000'>(</font><font color='#0000AA'>int</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
         				 <font color='#AA0000'>(</font><font color='#008800'>"year"</font> <font color='#AA0000'>(</font><font color='#0000AA'>int</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
                 <font color='#AA0000'>(</font><font color='#0000AA'>true</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
             <font color='#AA0000'>(</font><font color='#0000AA'>if</font> as-assoc <font color='#AA0000'>(</font><font color='#0000AA'>list</font> <font color='#AA0000'>(</font>:name field<font color='#AA0000'>)</font> value<font color='#AA0000'>)</font> value<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
           lengths
           cols
           <font color='#AA0000'>(</font><font color='#0000AA'>sequence</font> <font color='#665500'>0</font> <font color='#AA0000'>(</font><font color='#0000AA'>-</font> <font color='#AA0000'>(</font><font color='#0000AA'>length</font> cols<font color='#AA0000'>)</font> <font color='#665500'>1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#555555'>; Either return the row value or free the result and return nil.</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>zero?</font> ptr<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>begin</font> <font color='#AA0000'>(</font>:free inst<font color='#AA0000'>)</font> <font color='#0000AA'>nil</font><font color='#AA0000'>)</font>
    row<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:fetch-all &lt;MysqlResult-instance&gt; &lt;as-assoc&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;MysqlResult-instance&gt; an instance of the MysqlResult class</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;as-assoc&gt; (optional) whether to return results as a list or association list</font>
<font color='#555555'>;; &lt;p&gt;Returns all rows from this result. If &lt;as-assoc&gt; is true, the results</font>
<font color='#555555'>;; will be returned as an association list (true by default).&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>MysqlResult:fetch-all inst <font color='#AA0000'>(</font>as-assoc <font color='#0000AA'>true</font><font color='#AA0000'>)</font> , rows row<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> rows '<font color='#AA0000'>(</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> row <font color='#AA0000'>(</font>:fetch-row inst as-assoc<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>while</font> row
    <font color='#AA0000'>(</font><font color='#0000AA'>push</font> row rows<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> row <font color='#AA0000'>(</font>:fetch-row inst as-assoc<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  rows<font color='#AA0000'>)</font>

<font color='#555555'>;;;============================================================================</font>
<font color='#555555'>;;; MysqlField: A field in a MySQL result set</font>
<font color='#555555'>;;;============================================================================</font>

<font color='#555555'>;typedef struct st_mysql_field {</font>
<font color='#555555'>;  char *name;                 /* Name of column */</font>
<font color='#555555'>;  char *org_name;             /* Original column name, if an alias */</font>
<font color='#555555'>;  char *table;                /* Table of column if column was a field */</font>
<font color='#555555'>;  char *org_table;            /* Org table name, if table was an alias */</font>
<font color='#555555'>;  char *db;                   /* Database for table */</font>
<font color='#555555'>;  char *catalog;              /* Catalog for table */</font>
<font color='#555555'>;  char *def;                  /* Default value (set by mysql_list_fields) */</font>
<font color='#555555'>;  unsigned long length;       /* Width of column (create length) */</font>
<font color='#555555'>;  unsigned long max_length;   /* Max width for selected set */</font>
<font color='#555555'>;  unsigned int name_length;</font>
<font color='#555555'>;  unsigned int org_name_length;</font>
<font color='#555555'>;  unsigned int table_length;</font>
<font color='#555555'>;  unsigned int org_table_length;</font>
<font color='#555555'>;  unsigned int db_length;</font>
<font color='#555555'>;  unsigned int catalog_length;</font>
<font color='#555555'>;  unsigned int def_length;</font>
<font color='#555555'>;  unsigned int flags;         /* Div flags */</font>
<font color='#555555'>;  unsigned int decimals;      /* Number of decimals in field */</font>
<font color='#555555'>;  unsigned int charsetnr;     /* Character set */</font>
<font color='#555555'>;  enum enum_field_types type; /* Type of field. See mysql_com.h for types */</font>
<font color='#555555'>;} MYSQL_FIELD;</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (MysqlField &lt;int-pointer&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;int-pointer&gt; a pointer to a MYSQL_FIELD struct</font>
<font color='#555555'>;; &lt;p&gt;Objects of this class are returned by MysqlResult:fields.  It is used</font>
<font color='#555555'>;; internally in generating result rows. This class is not generally</font>
<font color='#555555'>;; instantiated directly by the client.&lt;/p&gt;</font>

<font color='#AA0000'>(</font><font color='#0000AA'>setf</font> MysqlField:types <font color='#555555'>; see mysql_com.h for enum details</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>list</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>append</font> <font color='#AA0000'>(</font><font color='#0000AA'>sequence</font> <font color='#665500'>0</font> <font color='#665500'>16</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>sequence</font> <font color='#665500'>246</font> <font color='#665500'>255</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    '<font color='#AA0000'>(</font><font color='#008800'>"decimal"</font> <font color='#008800'>"tinyint"</font> <font color='#008800'>"smallint"</font> <font color='#008800'>"integer"</font> <font color='#008800'>"float"</font> <font color='#008800'>"double"</font> <font color='#008800'>"null"</font> <font color='#008800'>"timestamp"</font>
      <font color='#008800'>"bigint"</font> <font color='#008800'>"mediumint"</font> <font color='#008800'>"date "</font> <font color='#008800'>"time"</font> <font color='#008800'>"datetime"</font> <font color='#008800'>"year"</font> <font color='#008800'>"newdate"</font> <font color='#008800'>"varchar"</font>
      <font color='#008800'>"bit"</font> <font color='#008800'>"decimal"</font> <font color='#008800'>"enum"</font> <font color='#008800'>"set"</font> <font color='#008800'>"tiny blob"</font> <font color='#008800'>"medium blob"</font> <font color='#008800'>"long blob"</font> <font color='#008800'>"blob"</font>
      <font color='#008800'>"varchar"</font> <font color='#008800'>"char"</font> <font color='#008800'>"geometry"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>if</font> _MYSQL:is-64-bit
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> MysqlField:pack-format <font color='#AA0000'>(</font><font color='#0000AA'>append</font> <font color='#AA0000'>(</font><font color='#0000AA'>dup</font> <font color='#008800'>"Lu"</font> <font color='#665500'>9</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>dup</font> <font color='#008800'>"lu"</font> <font color='#665500'>11</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> <font color='#555555'>; use 64-bit pointers</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> MysqlField:pack-format <font color='#AA0000'>(</font><font color='#0000AA'>append</font> <font color='#AA0000'>(</font><font color='#0000AA'>dup</font> <font color='#008800'>"lu"</font> <font color='#665500'>20</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:name &lt;MysqlField-instance&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;MysqlField-instance&gt; an instance of the MysqlField class</font>
<font color='#555555'>;; &lt;p&gt;Returns the name of this field (or its alias).&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>MysqlField:name inst<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>get-string</font> <font color='#AA0000'>(</font>:member inst <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:table &lt;MysqlField-instance&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;MysqlField-instance&gt; an instance of the MysqlField class</font>
<font color='#555555'>;; &lt;p&gt;Returns this field's table (or its alias).&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>MysqlField:table inst<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>get-string</font> <font color='#AA0000'>(</font>:member inst <font color='#665500'>2</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (:type &lt;MysqlField-instance&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;MysqlField-instance&gt; an instance of the MysqlField class</font>
<font color='#555555'>;; &lt;p&gt;Returns this field's type.&lt;/p&gt;</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>MysqlField:type inst<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>lookup</font> <font color='#AA0000'>(</font>:member inst <font color='#665500'>19</font><font color='#AA0000'>)</font> MysqlField:types<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;;;============================================================================</font>
<font color='#555555'>;;; mysql context contains convenience functions for working with MySQL</font>
<font color='#555555'>;;; databases</font>
<font color='#555555'>;;;============================================================================</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> 'mysql<font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (mysql:on-connect &lt;list-credentials&gt; &lt;fn-callback&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;list-credentials&gt; a list of parameters to pass to Mysql:connect</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;fn-callback&gt; a function to call with the database connection</font>
<font color='#555555'>;; &lt;p&gt;Connects to a MySQL server using &lt;list-credentials&gt; and calls</font>
<font color='#555555'>;; &lt;fn-callback&gt; using the Mysql instance as the first argument. If an</font>
<font color='#555555'>;; error occurred attempting connection, the error string is passed as the</font>
<font color='#555555'>;; second parameter. The minimum contents of &lt;list-credentials&gt; must be</font>
<font color='#555555'>;; '(&lt;str-host&gt; &lt;str-username&gt; &lt;str-password&gt; &lt;str-database&gt;).&lt;/p&gt;</font>
<font color='#555555'>;; &lt;p&gt;The connection is automatically freed when mysql:on-connect returns.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (mysql:on-connect '("localhost" "user" "secret" "my_database")</font>
<font color='#555555'>;;   (lambda (db err)</font>
<font color='#555555'>;;     (if err</font>
<font color='#555555'>;;       (println "Error! " err)</font>
<font color='#555555'>;;       (println "Success! " db))))</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>on-connect credentials func , db err success? result<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> db <font color='#AA0000'>(</font>Mysql<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>catch</font> <font color='#AA0000'>(</font><font color='#0000AA'>eval</font> <font color='#AA0000'>(</font><font color='#0000AA'>append</font> '<font color='#AA0000'>(</font>:connect db<font color='#AA0000'>)</font> credentials<font color='#AA0000'>)</font><font color='#AA0000'>)</font> 'err<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> success? <font color='#AA0000'>(</font><font color='#0000AA'>catch</font> <font color='#AA0000'>(</font>func db<font color='#AA0000'>)</font> 'result<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> success? <font color='#AA0000'>(</font><font color='#0000AA'>catch</font> <font color='#AA0000'>(</font>func db err<font color='#AA0000'>)</font> 'result<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>:close-db db<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> success? result <font color='#AA0000'>(</font><font color='#0000AA'>throw-error</font> <font color='#AA0000'>(</font><font color='#0000AA'>replace</font> <font color='#008800'>{(ERR: user error : )+}</font> result <font color='#008800'>""</font> <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (mysql:row-iter &lt;Mysql-instance&gt; &lt;str-sql&gt; &lt;bool-as-assoc&gt; &lt;fn-callback&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;Mysql-instance&gt; a connect instance of the Mysql class</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-sql&gt; a sql statement</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;bool-as-assoc&gt; flags whether or not to pass rows as regular or association lists</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;fn-callback&gt; a function to call for each row returned by the query</font>
<font color='#555555'>;; &lt;p&gt;Iterates over the results of a query, passing a row at a time to</font>
<font color='#555555'>;; &lt;fn-callback&gt;. The MysqlResult is automatically freed. The return value</font>
<font color='#555555'>;; of mysql:row-iter is the result of the last call to &lt;fn-callback&gt;.&lt;/p&gt;</font>
<font color='#555555'>;; &lt;p&gt;Note that each row is called with MysqlResult:fetch-row to avoid building</font>
<font color='#555555'>;; intermediate lists.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (mysql:on-connect '("localhost" "user" "secret" "my_database")</font>
<font color='#555555'>;;   (lambda (db err)</font>
<font color='#555555'>;;     (if err</font>
<font color='#555555'>;;       (println "Error! " err)</font>
<font color='#555555'>;;       (mysql:row-iter db "SELECT * FROM some_table" true</font>
<font color='#555555'>;;         (lambda (row) (println row))))))</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>row-iter db sql as-assoc func , result row<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> result <font color='#AA0000'>(</font>:query db sql<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>while</font> <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> row <font color='#AA0000'>(</font>:fetch-row result as-assoc<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font>func row<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (mysql:row-map &lt;Mysql-instance&gt; &lt;str-sql&gt; &lt;bool-as-assoc&gt; &lt;fn-callback&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;Mysql-instance&gt; a connect instance of the Mysql class</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-sql&gt; a sql statement</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;bool-as-assoc&gt; flags whether or not to pass rows as regular or association lists</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;fn-callback&gt; a function to apply to each row returned by the query</font>
<font color='#555555'>;; &lt;p&gt;Maps &lt;fn-callback&gt; over each row returned by querying &lt;Mysql-instance&gt;</font>
<font color='#555555'>;; with &lt;str-sql&gt;. Memory used by the MysqlResult is automatically freed.</font>
<font color='#555555'>;; Returns a list of the result of applying &lt;fn-callback&gt; to each row.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (mysql:on-connect '("localhost" "user" "secret" "my_database")</font>
<font color='#555555'>;;   (lambda (db err)</font>
<font color='#555555'>;;     (if err</font>
<font color='#555555'>;;       (println "Error! " err)</font>
<font color='#555555'>;;       (mysql:row-iter db "SELECT * FROM some_table" true first))))</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>row-map db sql as-assoc func , res result rows<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> result <font color='#AA0000'>(</font>:query db sql<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>catch</font> <font color='#AA0000'>(</font>:fetch-all result as-assoc<font color='#AA0000'>)</font> 'rows<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>map</font> func rows<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (mysql:reduce-results &lt;Mysql-instance&gt; &lt;str-sql&gt; &lt;bool-as-assoc&gt; &lt;fn-callback&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;Mysql-instance&gt; a connect instance of the Mysql class</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-sql&gt; a sql statement</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;bool-as-assoc&gt; flags whether or not to pass rows as regular or association lists</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;fn-callback&gt; a function to be applied in reducing the results of the query</font>
<font color='#555555'>;; &lt;p&gt;Reduces the results of the query by applying &lt;fn-callback&gt; successively</font>
<font color='#555555'>;; to slices of the list of rows from the left.  On the first call to</font>
<font color='#555555'>;; &lt;fn-callback&gt;, the arguments will be a number of rows equal to the number of</font>
<font color='#555555'>;; parameters that &lt;fn-callback&gt; accepts. On each subsequent call, the first</font>
<font color='#555555'>;; parameter will be replaced by the result of the previous call. See the</font>
<font color='#555555'>;; <font color='#308080'>@link</font> http://www.newlisp.org/newlisp_manual.html#apply apply&amp;nbsp;function</font>
<font color='#555555'>;; for a more detailed description of the mechanics of apply/reduce. The return</font>
<font color='#555555'>;; value is the result of the final application of &lt;fn-callback&gt;.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (mysql:on-connect '("localhost" "user" "secret" "my_database")</font>
<font color='#555555'>;;   (lambda (db err)</font>
<font color='#555555'>;;     (if err</font>
<font color='#555555'>;;       (println "Error! " err)</font>
<font color='#555555'>;;       (mysql:row-reduce db "SELECT * FROM some_table" true</font>
<font color='#555555'>;;         (lambda (row-1 row-2)</font>
<font color='#555555'>;;           (+ (if (list? row-1) (first row-1) row-1) (first row-2)))))))</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>row-reduce db sql as-assoc func , reduce-by rows arg-list<font color='#AA0000'>)</font>
  <font color='#555555'>; Determine the number of rows to reduce by on each call</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> arg-list <font color='#AA0000'>(</font><font color='#0000AA'>map</font> name <font color='#AA0000'>(</font><font color='#0000AA'>first</font> func<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>find</font> <font color='#008800'>","</font> arg-list<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> reduce-by <font color='#AA0000'>(</font><font color='#0000AA'>length</font> <font color='#AA0000'>(</font><font color='#0000AA'>rest</font> <font color='#AA0000'>(</font><font color='#0000AA'>member</font> <font color='#008800'>","</font> <font color='#AA0000'>(</font><font color='#0000AA'>reverse</font> arg-list<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> reduce-by <font color='#AA0000'>(</font><font color='#0000AA'>length</font> arg-list<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#555555'>; Perform reduction</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> result <font color='#AA0000'>(</font>:query db sql<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>catch</font> <font color='#AA0000'>(</font>:fetch-all result as-assoc<font color='#AA0000'>)</font> 'rows<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>apply</font> func rows reduce-by<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> 'MAIN<font color='#AA0000'>)</font>











</pre><center><font face='Arial' size='-3' color='#666666'>syntax highlighting with <a href="http://newlisp.org">newLISP</a>&nbsp;and <a href="http://newlisp.org/newLISPdoc.html">newLISPdoc</a></font></center></body></html>
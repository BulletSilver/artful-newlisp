<!DOCTYPE HTML PUBLIC "4.01 Transitional"><html><title>CSV</title><body><pre>
<font color='#555555'>;; <font color='#308080'>@module</font> CSV</font>
<font color='#555555'>;; <font color='#308080'>@author</font> Jeff Ober &lt;jeffober@gmail.com&gt;</font>
<font color='#555555'>;; <font color='#308080'>@version</font> 1.1</font>
<font color='#555555'>;; <font color='#308080'>@location</font> http://static.artfulcode.net/newlisp/csv.lsp</font>
<font color='#555555'>;; <font color='#308080'>@package</font> http://static.artfulcode.net/newlisp/csv.qwerty</font>
<font color='#555555'>;; <font color='#308080'>@description</font> Functions for parsing CSV files (updated for newlisp 10)</font>
<font color='#555555'>;; &lt;h4&gt;Version history&lt;/h4&gt;</font>
<font color='#555555'>;; &lt;b&gt;1.1&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; fixed incompatibilities with newlisp 10</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; &lt;b&gt;1.0&lt;/b&gt;</font>
<font color='#555555'>;; &amp;bull; initial release</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> 'CSV<font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> *quote-char* <font color='#008800'>"&#092;&#034;"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> *delimiter* <font color='#008800'>","</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>regex-token-quoted-string delimiter quote-char<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>format</font> <font color='#008800'>"^(%s((?:[^%s]|%s%s)+?)%s)(%s|$)"</font>
		  quote-char
		  quote-char
		  quote-char
		  quote-char
		  quote-char 
		  delimiter<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>regex-token-atom delimiter quote-char<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>format</font> <font color='#008800'>"^([^%s%s]+?)(?:%s|$)"</font>
		  quote-char
		  delimiter
		  delimiter<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>regex-token-empty delimiter<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>format</font> <font color='#008800'>"^%s(?:%s|$)"</font>
		  delimiter
		  delimiter<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (CSV:make-row-parser &lt;str-delimiter&gt; &lt;str-quote-char&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-delimiter&gt; column delimiter</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-quote-char&gt; character denoting quoted strings</font>
<font color='#555555'>;; &lt;p&gt;Returns a lambda that is able to parse a single row of CSV text.</font>
<font color='#555555'>;; The created function returns a list of column values.&lt;/p&gt;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (setq parser (CSV:make-row-parser "," "&#092;&#034;"))</font>
<font color='#555555'>;; => parser function</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; (parser "foo,bar,baz,bat")</font>
<font color='#555555'>;; => ("foo" "bar" "baz" "bat")</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; (setq parser (CSV:make-row-parser "|" "&#092;&#034;"))</font>
<font color='#555555'>;; => parser function</font>
<font color='#555555'>;; </font>
<font color='#555555'>;; (parser "foo|bar|baz|bat")</font>
<font color='#555555'>;; => ("foo" "bar" "baz" "bat")</font>

<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> re-chars <font color='#008800'>"|[]&#123;&#125;()<>?&#092;^$*+!:."</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>make-row-parser delimiter quote-char<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>find</font> delimiter re-chars<font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> delimiter <font color='#AA0000'>(</font><font color='#0000AA'>string</font> "\&#092;&#034; delimiter<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>find</font> quote-char re-chars<font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> quote-char <font color='#AA0000'>(</font><font color='#0000AA'>string</font> "\&#092;&#034; quote-char<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>letex</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>re1 <font color='#AA0000'>(</font><font color='#0000AA'>regex-comp</font> <font color='#AA0000'>(</font>regex-token-quoted-string delimiter quote-char<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
		  <font color='#AA0000'>(</font>re2 <font color='#AA0000'>(</font><font color='#0000AA'>regex-comp</font> <font color='#AA0000'>(</font>regex-token-atom delimiter quote-char<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
		  <font color='#AA0000'>(</font>re3 <font color='#AA0000'>(</font><font color='#0000AA'>regex-comp</font> <font color='#AA0000'>(</font>regex-token-empty delimiter<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
	<font color='#AA0000'>(</font>lambda <font color='#AA0000'>(</font>line<font color='#AA0000'>)</font>
	  <font color='#AA0000'>(</font><font color='#0000AA'>let</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>re-1 re1<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>re-2 re2<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>re-3 re3<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
		<font color='#AA0000'>(</font><font color='#0000AA'>let</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>parser <font color='#AA0000'>(</font>lambda <font color='#AA0000'>(</font>ln , m<font color='#AA0000'>)</font>
						<font color='#AA0000'>(</font><font color='#0000AA'>cond</font>
						 <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>set</font> 'm <font color='#AA0000'>(</font><font color='#0000AA'>regex</font> re-1 ln <font color='#665500'>0x10000</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
						  <font color='#AA0000'>(</font><font color='#0000AA'>cons</font> $2 <font color='#AA0000'>(</font>parser <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>+</font> <font color='#AA0000'>(</font>m <font color='#665500'>1</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>m <font color='#665500'>2</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> ln<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
						 <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>set</font> 'm <font color='#AA0000'>(</font><font color='#0000AA'>regex</font> re-2 ln <font color='#665500'>0x10000</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
						  <font color='#AA0000'>(</font><font color='#0000AA'>cons</font> $1 <font color='#AA0000'>(</font>parser <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>+</font> <font color='#AA0000'>(</font>m <font color='#665500'>1</font><font color='#AA0000'>)</font> <font color='#AA0000'>(</font>m <font color='#665500'>2</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font> ln<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
						 <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>set</font> 'm <font color='#AA0000'>(</font><font color='#0000AA'>regex</font> re-3 ln <font color='#665500'>0x10000</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
						  <font color='#AA0000'>(</font><font color='#0000AA'>cons</font> <font color='#008800'>{}</font> <font color='#AA0000'>(</font>parser <font color='#AA0000'>(</font><font color='#665500'>1</font> ln<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
						 <font color='#AA0000'>(</font><font color='#0000AA'>true</font> '<font color='#AA0000'>(</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
		  <font color='#AA0000'>(</font>parser line<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (CSV:parse-string &lt;str-text&gt; [&lt;str-delimiter&gt; [&lt;str-quote-char&gt;]])</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-text&gt; the text to be parsed</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-delimiter&gt; column delimiter</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-quote-char&gt; character denoting quoted strings</font>
<font color='#555555'>;; &lt;p&gt;Parses a string of text as a CSV file.  Returns a list with one element</font>
<font color='#555555'>;; for each line; each element is a list of column values for each line in the</font>
<font color='#555555'>;; text.&lt;/p&gt;</font>

<font color='#AA0000'>(</font><font color='#0000AA'>setq</font> EOL-re <font color='#AA0000'>(</font><font color='#0000AA'>regex-comp</font> <font color='#008800'>"&#092;n|&#092;r"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>parse-string str <font color='#AA0000'>(</font>delimiter *delimiter*<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>quote-char *quote-char*<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#008800'>"Parses an entire string into a nested list of rows."</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#AA0000'>(</font>make-row-parser delimiter quote-char<font color='#AA0000'>)</font>
	   <font color='#AA0000'>(</font><font color='#0000AA'>parse</font> str EOL-re <font color='#665500'>0x10000</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (CSV:parse-file &lt;str-file&gt; [&lt;str-delimiter&gt; [&lt;str-quote-char&gt;]])</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-file&gt; the file to be read and parsed</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-delimiter&gt; column delimiter</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-quote-char&gt; character denoting quoted strings</font>
<font color='#555555'>;; &lt;p&gt;Parses a CSV text file.  Returns a list with one element</font>
<font color='#555555'>;; for each line; each element is a list of column values for each line in the</font>
<font color='#555555'>;; text.  &lt;parse-file&gt; parses line by line, rather than processing the entire</font>
<font color='#555555'>;; string at once, and is therefore more efficient than &lt;parse-file&gt;.&lt;/p&gt;</font>
<font color='#555555'>;; &lt;p&gt;&lt;b&gt;Note:&lt;/b&gt; at least some versions of MS Excel use a single \r for</font>
<font color='#555555'>;; line endings, rather than a line feed or both.  newLISP's read-line will</font>
<font color='#555555'>;; only treat \n or \r\n as line endings.  If all columns are lumped into one</font>
<font color='#555555'>;; flat list, this may be the culprit.  In this case, use &lt;parse-string&gt; with</font>
<font color='#555555'>;; &lt;read-file&gt; instead as the best alternative.&lt;/p&gt;</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>parse-file path <font color='#AA0000'>(</font>delimiter *delimiter*<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>quote-char *quote-char*<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>let</font> <font color='#AA0000'>(</font><font color='#AA0000'>(</font>f <font color='#AA0000'>(</font><font color='#0000AA'>open</font> path <font color='#008800'>"r"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
		<font color='#AA0000'>(</font>parser <font color='#AA0000'>(</font>make-row-parser delimiter quote-char<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
		<font color='#AA0000'>(</font>rows '<font color='#AA0000'>(</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
		<font color='#AA0000'>(</font>buff<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
	<font color='#AA0000'>(</font><font color='#0000AA'>while</font> <font color='#AA0000'>(</font><font color='#0000AA'>setq</font> buff <font color='#AA0000'>(</font><font color='#0000AA'>read-line</font> f<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
	  <font color='#AA0000'>(</font><font color='#0000AA'>push</font> <font color='#AA0000'>(</font>parser buff<font color='#AA0000'>)</font> rows <font color='#665500'>-1</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
	<font color='#AA0000'>(</font><font color='#0000AA'>close</font> f<font color='#AA0000'>)</font>
	rows<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (CSV:list->row &lt;list-cols&gt; &lt;str-delimiter&gt; &lt;str-quote-char&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-delimiter&gt; column delimiter; defaults to ","</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-quote-char&gt; character denoting quoted strings; defaults to "&#092;&#034;"</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-quote-char&gt; character denoting quoted strings</font>
<font color='#555555'>;; &lt;p&gt;Generates one row of CSV data from the values in &lt;list-cols&gt;.  Non-numeric</font>
<font color='#555555'>;; elements are treated as quoted strings.&lt;/p&gt;</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>list->row lst <font color='#AA0000'>(</font>delimiter *delimiter*<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>quote-char *quote-char*<font color='#AA0000'>)</font>, <font color='#AA0000'>(</font>buff <font color='#008800'>""</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>dolist</font> <font color='#AA0000'>(</font>elt lst<font color='#AA0000'>)</font>
	<font color='#AA0000'>(</font><font color='#0000AA'>write-buffer</font> buff <font color='#AA0000'>(</font><font color='#0000AA'>if</font> <font color='#AA0000'>(</font><font color='#0000AA'>number?</font> elt<font color='#AA0000'>)</font> <font color='#AA0000'>(</font><font color='#0000AA'>string</font> elt<font color='#AA0000'>)</font>
						   <font color='#AA0000'>(</font><font color='#0000AA'>format</font> <font color='#008800'>"%s%s%s"</font> quote-char <font color='#AA0000'>(</font><font color='#0000AA'>string</font> elt<font color='#AA0000'>)</font> quote-char<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
	<font color='#AA0000'>(</font><font color='#0000AA'>write-buffer</font> buff <font color='#008800'>","</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  buff<font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (CSV:list->csv &lt;list-rows&gt; &lt;str-delimiter&gt; &lt;str-quote-char&gt; &lt;str-eol&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;list-rows&gt; list of row sets (each is a list of values)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-delimiter&gt; column delimiter; defaults to ","</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-quote-char&gt; character denoting quoted strings; defaults to "&#092;&#034;"</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;str-eol&gt; end of line character; defaults to "&#092;n"</font>
<font color='#555555'>;; &lt;p&gt;Generates CSV string of a list of column value sets.&lt;/p&gt;</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>list->csv lst <font color='#AA0000'>(</font>delimiter *delimiter*<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>quote-char *quote-char*<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>eol-str <font color='#008800'>"&#092;n"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>join</font> <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#AA0000'>(</font>fn <font color='#AA0000'>(</font>r<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>list->row r delimiter quote-char<font color='#AA0000'>)</font><font color='#AA0000'>)</font> lst<font color='#AA0000'>)</font> eol-str<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> MAIN<font color='#AA0000'>)</font>


</pre><center><font face='Arial' size='-3' color='#666666'>syntax highlighting with <a href="http://newlisp.org">newLISP</a>&nbsp;and <a href="http://newlisp.org/newLISPdoc.html">newLISPdoc</a></font></center></body></html>
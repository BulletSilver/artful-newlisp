<!DOCTYPE HTML PUBLIC "HTML 4.01 Transitional">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>web.lsp</title>

<link rel="stylesheet" type="text/css" href="newlispdoc.css" />
</head>

<body style="margin: 20px;" text="#111111" bgcolor="#FFFFFF" 
			link="#376590" vlink="#551A8B" alink="#ffAA28">
<blockquote>
<center><h1>web.lsp</h1></center>
<p><a href="index.html">Module index</a></p><a href="web.lsp.src.html">source</a>&nbsp;<br/>
<h2>Module:&nbsp;Web</h2><b>Author: </b>Jeff Ober <jeffober@gmail.com>, Kanen Flowers <kanendosei@gmail.com><br/>
<b>Version: </b>0.3.2<br/>
<b>Location: </b><a href="http://www.ScruffyThinking.com/artful">http://www.ScruffyThinking.com/artful</a><br/>
<b>package: </b>https://github.com/LifeZero/artful-newlisp/blob/master/web.qwerty<br/>
<p>A collection of functions for writing web-based software.</p>
 <b>Features:</b>
 <ul>
   <li>ASP/PHP-style templates</li>
   <li>Cookies</li>
   <li>Entities translation</li>
   <li>GET/POST parameters</li>
   <li>HTTP header control</li>
   <li>Sessions</li>
   <li>URL building and parsing</li>
   <li>URL encoding and decoding</li>
   <li>query building and parsing</li>
 </ul>
 <b>Known issues</b>
 <ul>
   <li>
     When used in conjunction with the official 
     <a href="http://newlisp.nfshost.com/code/modules/cgi.lsp.html">CGI</a>      module, <a href="http://newlisp.nfshost.com/code/modules/cgi.lsp.html">CGI</a> must be loaded first. In the case of
     identical GET and POST parameters, the value is stored in GET, but the value will be POST. This
     is due to the fact that CGI stores both GET and POST in the same association list and overwrites
     GET values with POST.
   </li>
 </ul>
<br/><br/>
 <b>Note:</b> for JSON encoding and decoding, see the <a href="http://static.artfulcode.net/newlisp/json.lsp.html">Json</a> module.
<br/><br/>
 <h4>To do</h4>
 &bull; add MIME decoding for multipart posts
<br/><br/>
 <h4>Version history</h4>
 <b>0.3.1</b>
 &bull; fixed ineffective usage of set/setf
<br/><br/>
 <b>0.3</b>
 &bull; made parse-query more tolerant and fixed parsing bug
 &bull; cookie now accepts an additional parameter that only permits access during HTTPS sessions
<br/><br/>
 <b>0.2</b>
 &bull; build-url now accepts query strings in addition to assoc lists
 &bull; session-id now accepts an optional parameter to set the session id
 &bull; fixed some typos with <tt>clean-sessions</tt>
 &bull; fixed extra parameter in <tt>define-session-handlers</tt>
<br/><br/>
 <b>0.1</b>
 &bull; initial release
<br/><br/>
<br/><br/><center>&sect;</center><br/>
<a name="Web_escape-js"></a><h3><font color=#CC0000>Web:escape-js</font></h3>
<b>syntax: (<font color=#CC0000>Web:escape-js</font> <em>str</em>)</b><br/>
<b>parameter: </b><em>str</em> - a string to escape<br/>
 <p>Escapes a string for output in javascript. Does not encode entities;
 just prevents control characters from causing syntax errors in javascript.</p>

<br/><br/><center>&sect;</center><br/>
<a name="Web_escape"></a><h3><font color=#CC0000>Web:escape</font></h3>
<b>syntax: (<font color=#CC0000>Web:escape</font> <em>str</em>)</b><br/>
<b>parameter: </b><em>str</em> - a string to escape<br/>
<p><b>return: </b>the escaped string</p>
 <p>Escapes characters that are part of the (X)HTML and XML syntax to prevent
 characters from confusing browsers' parsing of markup. Escapes single and
 double quotes, ampersands, and left and right angle brackets
 (<tt>&quot;</tt>, <tt>&apos;</tt>, <tt>&amp;</tt>, <tt>&lt;</tt>, and <tt>&gt;</tt>).</p>

<br/><br/><center>&sect;</center><br/>
<a name="Web_unescape"></a><h3><font color=#CC0000>Web:unescape</font></h3>
<b>syntax: (<font color=#CC0000>Web:unescape</font> <em>str</em>)</b><br/>
<b>parameter: </b><em>str</em> - an entity-escaped string<br/>
<p><b>return: </b>the unescaped string</p>
 <p>Unescapes the basic (X)HTML and XML character entities in a string.</p>

<br/><br/><center>&sect;</center><br/>
<a name="Web_encode-entities"></a><h3><font color=#CC0000>Web:encode-entities</font></h3>
<b>syntax: (<font color=#CC0000>Web:encode-entities</font> <em>str</em>)</b><br/>
<b>parameter: </b><em>str</em> - a string to escape<br/>
<p><b>return: </b>the escaped string</p>
 <p>Escapes characters with a much larger set of character entities than
 <tt>escape</tt> using a table derived from 
 <a href="http://en.wikipedia.org/wiki/List_of_XML_and_HTML_character_entity_references">Wikipedia.</a> 
<br/><br/><center>&sect;</center><br/>
<a name="Web_decode-entities"></a><h3><font color=#CC0000>Web:decode-entities</font></h3>
<b>syntax: (<font color=#CC0000>Web:decode-entities</font> <em>str</em>)</b><br/>
<b>parameter: </b><em>str</em> - an entity-encoded string<br/>
<p><b>return: </b>the decoded string</p>
 <p>Translates character entities to their character equivalents as well as
 numeric entities.</p>



<br/><br/><center>&sect;</center><br/>
<a name="Web_url-encode"></a><h3><font color=#CC0000>Web:url-encode</font></h3>
<b>syntax: (<font color=#CC0000>Web:url-encode</font> <em>str</em>)</b><br/>
<b>parameter: </b><em>str</em> - a string token to encode for use in a URL<br/>
<p><b>return: </b>the URL-encoded string</p>
 <p>Encodes a string for use in a URL.</p>


<br/><br/><center>&sect;</center><br/>
<a name="Web_url-decode"></a><h3><font color=#CC0000>Web:url-decode</font></h3>
<b>syntax: (<font color=#CC0000>Web:url-decode</font> <em>str</em>)</b><br/>
<b>parameter: </b><em>str</em> - a URL-encoded string<br/>
<p><b>return: </b>the decoded string</p>
 <p>Decodes hexidecimals and spaces (represented as '+') in a URL-encoded string.</p>


<br/><br/><center>&sect;</center><br/>
<a name="Web_parse-query"></a><h3><font color=#CC0000>Web:parse-query</font></h3>
<b>syntax: (<font color=#CC0000>Web:parse-query</font> <em>query-string</em>)</b><br/>
<b>parameter: </b><em>query-string</em> - a URL-encoded query string<br/>
<p><b>return: </b>an association list of decoded key-value pairs</p>
 <p>Parses a URL-encoded query string and returns a list of key-values pairs.</p>


<br/><br/><center>&sect;</center><br/>
<a name="Web_build-query"></a><h3><font color=#CC0000>Web:build-query</font></h3>
<b>syntax: (<font color=#CC0000>Web:build-query</font> <em>a-list</em>)</b><br/>
<b>parameter: </b><em>a-list</em> - an association list<br/>
<p><b>return: </b>a URL-encoded query string</p>
 <p>Builds a URL-encoded query string using <em>a-list</em>. Does not include the leading
 question mark (so queries may be easily built of association list fragments.)</p>

<br/><br/><center>&sect;</center><br/>
<a name="Web_parse-url"></a><h3><font color=#CC0000>Web:parse-url</font></h3>
<b>syntax: (<font color=#CC0000>Web:parse-url</font> <em>str-url</em>)</b><br/>
<b>parameter: </b><em>str-url</em> - a URL<br/>
<p><b>return: </b>an association list with the decomposed URL's parts</p>
 <p>Parses a URL and returns an association list of its decomposed parts. The list's
 keys (as strings) are: scheme, user, pass, host, port, path, query, and fragment.
 Also handles IPV6 addresses. Modeled on the PHP function of the same name.</p>
<br/><br/>
 Parsing based on code from <a href="http://us3.php.net/manual/en/function.parse-url.php#90365">this&nbsp;comment.</a> 

<br/><br/><center>&sect;</center><br/>
<a name="Web_build-url"></a><h3><font color=#CC0000>Web:build-url</font></h3>
<b>syntax: (<font color=#CC0000>Web:build-url</font> <em>str-url</em> [<em>list-query-params</em> ...])</b><br/>
<b>parameter: </b><em>str-url</em> - a string URL<br/>
<b>parameter: </b><em>list-query-params</em> - one or more association lists of query parameters and their values<br/>
<br/><br/>
<b>syntax: (<font color=#CC0000>Web:build-url</font> <em>list-url</em> [<em>list-query-params</em> ...])</b><br/>
<b>parameter: </b><em>list-url</em> - an association list of URL components using the structure of <em>parse-url</em>'s return value<br/>
<b>parameter: </b><em>list-query-params</em> - one or more association lists of query parameters and their values<br/>
<p><b>return: </b>a URL string composed of the initial URL data plus subsequently superseding query parameters</p>
 <p>In the first syntax, builds a URL from an existing URL string.
 In the second syntax, builds a URL from an association list in the same
 format as the return value of <em>parse-url</em>, with both keys and values being
 strings. In both syntaxes, any number of additional association lists of
 key/value pairs may be passed, which are serialized as query parameters, with
 each list overriding the previous. If there are query parameters in the
 initial URL, they are used as the initial list with the lowest priority.</p>

    


<br/><br/><center>&sect;</center><br/>
<a name="Web_header"></a><h3><font color=#CC0000>Web:header</font></h3>
<b>syntax: (<font color=#CC0000>Web:header</font> <em>str-key</em> <em>str-value</em>)</b><br/>
<b>parameter: </b><em>str-key</em> - the header name (e.g., "Content-type")<br/>
<b>parameter: </b><em>str-value</em> - the header value (e.g., "text/html")<br/>
 <p>Sets an HTTP output header. Headers are printed using <tt>Web:send-headers</tt>.</p>


<br/><br/><center>&sect;</center><br/>
<a name="Web_redir"></a><h3><font color=#CC0000>Web:redir</font></h3>
<b>syntax: (<font color=#CC0000>Web:redir</font> <em>str-url</em>)</b><br/>
<b>parameter: </b><em>str-url</em> - a URL string<br/>
 <p>Redirects the client to <em>str-url</em>.</p>

<br/><br/><center>&sect;</center><br/>
<a name="Web_send-headers"></a><h3><font color=#CC0000>Web:send-headers</font></h3>
<b>syntax: (<font color=#CC0000>Web:send-headers</font>)</b><br/>
 <p>Writes the HTTP headers to stdout. This function should be called regardless
 of whether any headers have been manually set to ensure that the minimum HTTP
 headers are properly sent. Note: no check is made to verify that output has not
 already begun.</p>

<br/><br/><center>&sect;</center><br/>
<a name="Web_cookie"></a><h3><font color=#CC0000>Web:cookie</font></h3>
<b>syntax: (<font color=#CC0000>Web:cookie</font> <em>str-key</em>)</b><br/>
<b>parameter: </b><em>str-key</em> - the cookie's name<br/>
<br/><br/>
<b>syntax: (<font color=#CC0000>Web:cookie</font> <em>str-key</em> <em>str-value</em> [<em>int-expires</em> [<em>str-path</em> [<em>str-domain</em> [<em>bool-http-only</em> [<em>bool-secure-only</em>]]]])</b><br/>
<b>parameter: </b><em>str-key</em> - the cookie's name<br/>
<b>parameter: </b><em>str-key</em> - the cookie's value<br/>
<b>parameter: </b><em>int-expires</em> - (optional) the expiration date of the cookie as a unix timestamp; default is a session cookie<br/>
<b>parameter: </b><em>str-path</em> - (optional) the cookie's path; default is the current path<br/>
<b>parameter: </b><em>str-domain</em> - (optional) the cookie's domain; default is the current host<br/>
<b>parameter: </b><em>bool-http-only</em> - (optional) whether the cookie may be read by client-side scripts<br/>
<b>parameter: </b><em>bool-secure-only</em> - (optional) whether the cookie may be accessed/set outside of HTTPS<br/>
 <p>In the first syntax, <tt>cookie</tt> returns the value of the cookie named <em>str-key</em> or <tt>nil</tt>. If
 <em>str-key</em> is not provided, an association list of all cookie values is returned.</p>
 <p>In the second syntax, <tt>cookie</tt> sets a new cookie or overwrites an existing cookie in the
 client's browser. Note that <em>bool-http-only</em> defaults to true, but is not standard and
 therefore is not necessarily implemented in all browsers. <em>bool-secure-only</em> defaults to nil.
 Cookies use the <tt>header</tt> function and must be sent before calling <tt>send-headers</tt>.</p>

<br/><br/><center>&sect;</center><br/>
<a name="Web_get"></a><h3><font color=#CC0000>Web:get</font></h3>
<b>syntax: (<font color=#CC0000>Web:get</font> <em>str-key</em>)</b><br/>
 <p>Returns the value of <em>str-key</em> in the query string or <tt>nil</tt> if not present.
 If <em>str-key</em> is not provided, returns an association list of all GET values.</p>

<br/><br/><center>&sect;</center><br/>
<a name="Web_post"></a><h3><font color=#CC0000>Web:post</font></h3>
<b>syntax: (<font color=#CC0000>Web:post</font> <em>str-key</em>)</b><br/>
 <p>Returns the value of <em>str-key</em> in the client-submitted POST data or <tt>nil</tt> if
 not present. If <em>str-key</em> is not provided, returns an association list of all
 POST values.</p>


<br/><br/><center>&sect;</center><br/>
<a name="Web_define-session-handlers"></a><h3><font color=#CC0000>Web:define-session-handlers</font></h3>
<b>syntax: (<font color=#CC0000>Web:define-session-handlers</font> <em>fn-open</em> <em>fn-close</em> <em>fn-delete</em> <em>fn-clear</em> <em>fn-clean</em>)</b><br/>
<b>parameter: </b><em>fn-open</em> - function to begin a new session<br/>
<b>parameter: </b><em>fn-close</em> - function to close a session, saving changes<br/>
<b>parameter: </b><em>fn-delete</em> - function to delete a session<br/>
<b>parameter: </b><em>fn-clean</em> - function to prune old sessions<br/>
 <p>Defines handler functions to be called when various session control
 functions are used, making custom session storage a fairly simple matter.</p>
 The required handler functions are:
 <ul>
 <li><tt>fn-open</tt>: called by <tt>open-session</tt>; resumes or starts a new session storage instance, initializing the context tree</li>
 <li><tt>fn-close</tt>: called by <tt>close-session</tt>; writes changes to a session to storage</li>
 <li><tt>fn-delete</tt>: called by <tt>delete-session</tt>; deletes the entire session from storage</li>
 <li><tt>fn-clean</tt>: called by <tt>clean-sessions</tt>; prunes old stored sessions</li>
 </ul>
 Some useful functions and variables for handler functions:
 <ul>
 <li><tt>session-id</tt>: function that returns the current session id and sets the session cookie when necessary</li>
 <li><tt>session-context</tt>: function that returns the session context dictionary</li>
 <li><tt>SESSION_MAX_AGE</tt>: a variable storing the number of seconds after which an orphan session should be deleted</li>
 </ul>

<br/><br/><center>&sect;</center><br/>
<a name="Web_session-id"></a><h3><font color=#CC0000>Web:session-id</font></h3>
<b>syntax: (<font color=#CC0000>Web:session-id</font> [<em>str-sid</em>])</b><br/>
<b>parameter: </b><em>str-sid</em> - (optional) the session ID to use<br/>
<p><b>return: </b>a unique session id for the client</p>
 <p>Creates or retrieves the client's session id. If this is a new session id,
 a cookie is set in the client's browser to identify it on future loads.</p>
 <p>If <em>str-sid</em> is provided, it will be used as the new session ID.</p>

<br/><br/><center>&sect;</center><br/>
<a name="Web_session-context"></a><h3><font color=#CC0000>Web:session-context</font></h3>
<b>syntax: (<font color=#CC0000>Web:session-context</font>)</b><br/>
<p><b>return: </b>a symbol pointing to the current session's context dictionary</p>
 <p>Run-time session data is stored in a context tree. <tt>session-context</tt>
 returns the current session tree or creates a new one when necessary.
 This function is primarily intended for session handlers' use; it is
 typically more useful to call <tt>session</tt> on its own to retrieve an association
 list of key/value pairs in an application.</p>

<br/><br/><center>&sect;</center><br/>
<a name="Web_open-session"></a><h3><font color=#CC0000>Web:open-session</font></h3>
<b>syntax: (<font color=#CC0000>Web:open-session</font>)</b><br/>
 <p>Initializes the client's session.</p>

<br/><br/><center>&sect;</center><br/>
<a name="_close-session"></a><h3><font color=#CC0000>close-session</font></h3>
<b>syntax: (<font color=#CC0000>close-session</font>)</b><br/>
 <p>Writes any changes to the session to file. This is automatically called
 when the distribution function <tt>exit</tt> is called.</p>

<br/><br/><center>&sect;</center><br/>
<a name="_delete-session"></a><h3><font color=#CC0000>delete-session</font></h3>
<b>syntax: (<font color=#CC0000>delete-session</font>)</b><br/>
 <p>Deletes the session. Sessions are then turned off and <tt>open-session</tt>
 must be called again to use sessions further.</p>

<br/><br/><center>&sect;</center><br/>
<a name="_clear-session"></a><h3><font color=#CC0000>clear-session</font></h3>
<b>syntax: (<font color=#CC0000>clear-session</font>)</b><br/>
 <p>Clears all session variables.</p>

<br/><br/><center>&sect;</center><br/>
<a name="_clean-sessions"></a><h3><font color=#CC0000>clean-sessions</font></h3>
<b>syntax: (<font color=#CC0000>clean-sessions</font>)</b><br/>
 <p>Cleans old session files. This function is not currently called automatically;
 note that there is the possibility of a race condition with this function and other
 session handling functions.</p>

<br/><br/><center>&sect;</center><br/>
<a name="_session"></a><h3><font color=#CC0000>session</font></h3>
<b>syntax: (<font color=#CC0000>session</font> [<em>str-key</em> [<em>str-value</em>]])</b><br/>
<b>parameter: </b><em>str-key</em> - the session key<br/>
<b>parameter: </b><em>str-value</em> - the new value<br/>
 When called with both <em>str-key</em> and <em>str-value</em>, sets the session variable. When
 called with only <em>str-key</em>, returns the value of <em>str-key</em>. Otherwise, returns
 an association list of session variables. Returns nil if the session is not
 opened.








<br/><br/><center>&sect;</center><br/>
<a name="Web_eval-template"></a><h3><font color=#CC0000>Web:eval-template</font></h3>
<b>syntax: (<font color=#CC0000>Web:eval-template</font> <em>str-template</em> <em>ctx-context</em>)</b><br/>
<b>parameter: </b><em>str-template</em> - a string containing the template syntax<br/>
<b>parameter: </b><em>ctx-context</em> - the context in which to evaluate the template<br/>
 <p>Translates a template using ASP-like tags, creating small islands of
 newLISP code in an HTML (or other) document. This is similar to the
 distribution CGI module&apos;s <tt>put-page</tt> function, except that the short-cut
 &lt;%= foo %&gt; is used to simply output the value of <tt>foo</tt> and tags
 may span multiple lines.</p>
 <p>Note that the opening and closing tags may be changed by setting the
 values of <tt>Web:OPEN_TAG</tt> and <tt>Web:CLOSE_TAG</tt> if desired. The shortcut
 print tag will be <tt>Web:OPEN_TAG</tt> + '='.</p>
<b>example:</b><blockquote><pre> (Web:eval-template "&lt;p&gt;&lt;%= (* 3 3) %&gt;&lt;/p&gt;")
 =&gt; "&lt;p&gt;9&lt;/p&gt;"
 (Web:eval-template "&lt;p&gt;&lt;% (println (* 3 3)) %&gt;&lt;/p&gt;")
 =&gt; "&lt;p&gt;9&lt;/p&gt;"</pre></blockquote>

<br/><br/><center>- &part; -</center><br/>
<center><font face='Arial' size='-2' color='#444444'>
generated with <a href="http://newlisp.org">newLISP</a>&nbsp;
and <a href="http://newlisp.org/newLISPdoc.html">newLISPdoc</a>
</font></center>
</blockquote>
</body>
</html>
